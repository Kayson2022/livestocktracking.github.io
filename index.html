<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Investment App</title>
Â  Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’°</text></svg>">
Â  Â  <!-- Third-party Libraries -->
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
Â  Â  <!-- Fonts -->
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

Â  Â  <style>
Â  Â  Â  Â  /* --- CSS variables for theming --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --bg-color: #F3F4F6;
Â  Â  Â  Â  Â  Â  --bg-gradient: linear-gradient(to bottom right, #f0f2f8, #e6e8f2);
Â  Â  Â  Â  Â  Â  --card-bg-color: #ffffff;
Â  Â  Â  Â  Â  Â  --text-color-primary: #111827;
Â  Â  Â  Â  Â  Â  --text-color-secondary: #6B7280;
Â  Â  Â  Â  Â  Â  --border-color: #E5E7EB; /* Solid light gray */
Â  Â  Â  Â  Â  Â  --shadow-color: rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  --header-text-color: #111827;
Â  Â  Â  Â  Â  Â  --input-bg-color: #ffffff;
Â  Â  Â  Â  Â  Â  --input-border-color: #D1D5DB;
Â  Â  Â  Â  Â  Â  --positive-color: #16A34A;
Â  Â  Â  Â  Â  Â  --negative-color: #DC2626;
Â  Â  Â  Â  Â  Â  --accent-color-1: #6D28D9;
Â  Â  Â  Â  Â  Â  --accent-color-2: #8B5CF6;
Â  Â  Â  Â  Â  Â  --card-bg-hover-color: #E9D5FF;
Â  Â  Â  Â  }
Â  Â  Â  Â  [data-theme="dark"] {
Â  Â  Â  Â  Â  Â  --bg-color: #111827;
Â  Â  Â  Â  Â  Â  --bg-gradient: linear-gradient(to bottom right, #1f2937, #111827);
Â  Â  Â  Â  Â  Â  --card-bg-color: #1F2937;
Â  Â  Â  Â  Â  Â  --text-color-primary: #F9FAFB;
Â  Â  Â  Â  Â  Â  --text-color-secondary: #9CA3AF;
Â  Â  Â  Â  Â  Â  --border-color: #374151; /* Solid dark gray */
Â  Â  Â  Â  Â  Â  --shadow-color: rgba(0, 0, 0, 0.25);
Â  Â  Â  Â  Â  Â  --header-text-color: #F9FAFB;
Â  Â  Â  Â  Â  Â  --input-bg-color: #374151;
Â  Â  Â  Â  Â  Â  --input-border-color: #4B5563;
Â  Â  Â  Â  Â  Â  --card-bg-hover-color: #4C1D95;
Â  Â  Â  Â  }
Â  Â  Â  Â  [data-theme="dark"] .investment-item {
Â  Â  Â  Â  Â  Â  background: var(--card-bg-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--bg-gradient);
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  color: var(--text-color-primary);
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s ease, color 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
Â  Â  Â  Â  .header { text-align: center; margin-bottom: 30px; color: var(--header-text-color); position: relative; }
Â  Â  Â  Â  .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 10px; }
Â  Â  Â  Â  #userNameDisplay { color: var(--text-color-primary); }
Â  Â  Â  Â  .data-status { position: absolute; top: 10px; right: 60px; /* Adjusted for settings icon */ background: rgba(255, 255, 255, 0.2); padding: 8px 12px; border-radius: 20px; font-size: 0.8em; color: var(--text-color-primary); backdrop-filter: blur(10px); white-space: nowrap; transition: background-color 0.3s ease; border: 1px solid var(--border-color); }
Â  Â  Â  Â  .data-status.saved { background: rgba(22, 163, 74, 0.2); border-color: rgba(22, 163, 74, 0.5); }
Â  Â  Â  Â  .data-status.loading { background: rgba(255, 193, 7, 0.2); border-color: rgba(255, 193, 7, 0.5); }
Â  Â  Â  Â  .data-status.error { background: rgba(220, 38, 38, 0.2); border-color: rgba(220, 38, 38, 0.5); }
Â  Â  Â  Â  .header-icon { background: var(--card-bg-color); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border-color); font-size: 1.2em; color: var(--text-color-secondary); position: absolute; top: 10px; z-index: 10; box-shadow: 0 2px 4px var(--shadow-color); }
Â  Â  Â  Â  .theme-toggle { left: 10px; }
Â  Â  Â  Â  .settings-toggle { right: 10px; font-size: 1.4em; }
Â  Â  Â  Â  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
Â  Â  Â  Â  .stat-card { background: var(--card-bg-color); padding: 25px 15px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px var(--shadow-color); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease; }
Â  Â  Â  Â  .stat-card:hover { transform: translateY(-8px); box-shadow: 0 8px 20px var(--shadow-color); }
Â  Â  Â  Â  .stat-value { font-size: 1.5em; font-weight: 700; margin-bottom: 5px; white-space: nowrap; }
Â  Â  Â  Â  .stat-label { color: var(--text-color-secondary); font-size: 0.9em; font-weight: 500; }
Â  Â  Â  Â  .charts-section { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 30px; }
Â  Â  Â  Â  .pie-charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
Â  Â  Â  Â  .chart-container { background: var(--card-bg-color); padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px var(--shadow-color); border: 1px solid var(--border-color); }
Â  Â  Â  Â  .chart-container h3 { text-align: center; margin-bottom: 15px; color: var(--text-color-primary); font-weight: 600; }
Â  Â  Â  Â  .chart-wrapper { position: relative; height: 300px; }
Â  Â  Â  Â  .chart-filters { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
Â  Â  Â  Â  .chart-filter-btn { background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color-secondary); padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; font-size: 0.8em; font-weight: 500; }
Â  Â  Â  Â  .chart-filter-btn:hover { background: #e5e7eb; }
Â  Â  Â  Â  .chart-filter-btn.active { background: var(--accent-color-1); color: white; border-color: var(--accent-color-1); }
Â  Â  Â  Â  .main-content { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; margin-bottom: 30px; }
Â  Â  Â  Â  .card-panel { background: var(--card-bg-color); padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px var(--shadow-color); border: 1px solid var(--border-color); }
Â  Â  Â  Â  .add-investment.card-panel { background-color: #F5F3FF; }
Â  Â  Â  Â  .investments-list.card-panel { background-color: transparent; box-shadow: none; border: none; padding: 0; }
Â  Â  Â  Â  .card-panel h2 { margin-bottom: 20px; color: var(--text-color-primary); font-weight: 600; }
Â  Â  Â  Â  .form-group { position: relative; margin-bottom: 15px; }
Â  Â  Â  Â  .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-color-secondary); }
Â  Â  Â  Â  .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--input-border-color); border-radius: 8px; font-size: 16px; font-family: 'Inter', sans-serif; background-color: var(--input-bg-color); color: var(--text-color-primary); transition: border-color 0.3s ease; }
Â  Â  Â  Â  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-color-1); box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.2); }
Â  Â  Â  Â  #userNameInput { background-color: var(--input-bg-color) !important; border-color: var(--input-border-color) !important; color: var(--text-color-primary) !important; }
Â  Â  Â  Â  #symbolValidationStatus { position: absolute; right: 10px; top: 38px; font-size: 1.2em; }
Â  Â  Â  Â  .btn { background: linear-gradient(45deg, var(--accent-color-1), var(--accent-color-2)); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; width: 100%; margin: 2px; }
Â  Â  Â  Â  .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .btn:disabled { background: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }
Â  Â  Â  Â  .investment-item { background: #F9FAFB; border-radius: 10px; margin-bottom: 15px; overflow: hidden; transition: all 0.3s ease; border: 1px solid var(--border-color); }
Â  Â  Â  Â  .investment-item:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 25px var(--shadow-color);
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg-hover-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .investment-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
Â  Â  Â  Â  .investment-header-info { text-align: left; }
Â  Â  Â  Â  .investment-header-actions .btn { padding: 6px 12px; font-size: 14px; width: auto; margin-left: 10px;}
Â  Â  Â  Â  .investment-symbol { font-size: 1.2em; font-weight: 700; color: var(--text-color-primary); }
Â  Â  Â  Â  .detail-value { font-weight: 600; color: var(--text-color-primary); }
Â  Â  Â  Â  .stat-value.positive, .detail-value.positive { color: var(--positive-color); }
Â  Â  Â  Â  .stat-value.negative, .detail-value.negative { color: var(--negative-color); }
Â  Â  Â  Â  .detail-label { font-size: 0.9em; color: var(--text-color-secondary); margin-bottom: 2px; font-weight: 500; }
Â  Â  Â  Â  .btn-danger { background: #EF4444; }
Â  Â  Â  Â  .btn-danger:hover { background: #DC2626; }
Â  Â  Â  Â  .btn-edit { background: #FBBF24; }
Â  Â  Â  Â  .btn-edit:hover { background: #F59E0B; }
Â  Â  Â  Â  .btn-secondary { background: linear-gradient(45deg, #8B5CF6, #7C3AED); }
Â  Â  Â  Â  .account-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600; color: white; margin-left: 10px; }
Â  Â  Â  Â  .account-regular { background: #3498db; } .account-roth { background: #e74c3c; } .account-401k { background: #f39c12; } .account-529 { background: #9b59b6; } .account-yahoo { background: #20c997; }
Â  Â  Â  Â  .investment-item:not(.consolidated) .investment-details {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  padding: 0 20px 20px 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .detail-item { text-align: center; }
Â  Â  Â  Â  .empty-state { text-align: center; padding: 40px; color: var(--text-color-secondary); }
Â  Â  Â  Â  #clearAllDataBtn { background: linear-gradient(45deg, #e74c3c, #c0392b); }
Â  Â  Â  Â  .investment-group { margin-bottom: 15px; border-radius: 10px; overflow: hidden; }
Â  Â  Â  Â  .investment-group-header { background: var(--card-bg-color); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px var(--shadow-color); margin-bottom: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); }
Â  Â  Â  Â  .investment-group-header[data-group-type="Regular Brokerage"] { border-left: 4px solid #3498db; }
Â  Â  Â  Â  .investment-group-header[data-group-type="Roth IRA"] { border-left: 4px solid #e74c3c; }
Â  Â  Â  Â  .investment-group-header[data-group-type="401(k)"] { border-left: 4px solid #f39c12; }
Â  Â  Â  Â  .investment-group-header[data-group-type="529 College Saving"] { border-left: 4px solid #9b59b6; }
Â  Â  Â  Â  .investment-group-header[data-group-type="Yahoo Finance"] { border-left: 4px solid #20c997; }
Â  Â  Â  Â  .investment-group-header:hover { transform: translateY(-2px); box-shadow: 0 4px 15px var(--shadow-color); }
Â  Â  Â  Â  .group-summary { flex-grow: 1; } .group-title { font-size: 1.3em; font-weight: 700; color: var(--text-color-primary); margin-bottom: 5px; } .group-stats { display: flex; gap: 15px; font-size: 0.9em; flex-wrap: wrap; } .group-stat-item .detail-label { font-size: 0.75em; color: var(--text-color-secondary); } .group-stat-item .detail-value { font-weight: 600; font-size: 1.1em; color: var(--text-color-primary); } .group-stat-item .detail-value.positive { color: var(--positive-color); } .group-stat-item .detail-value.negative { color: var(--negative-color); }
Â  Â  Â  Â  .toggle-icon { font-size: 1.5em; font-weight: bold; color: var(--accent-color-1); margin-left: 15px; transition: transform 0.2s ease; }
Â  Â  Â  Â  .investment-group.expanded .toggle-icon { transform: rotate(90deg); }
Â  Â  Â  Â  .investment-group-content { display: none; padding-top: 15px; background: transparent; }
Â  Â  Â  Â  .investment-group.expanded .investment-group-content { display: block; }
Â  Â  Â  Â  .refresh-button-container { text-align: right; margin-bottom: 20px; padding-right: 2px; }
Â  Â  Â  Â  .controls-bar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
Â  Â  Â  Â  .controls-bar .form-group { margin-bottom: 0; flex-grow: 1; } .controls-bar label { margin-right: 10px; font-weight: 600; } .controls-bar select, .controls-bar input { width: auto; min-width: 180px; }
Â  Â  Â  Â  /* MODAL STYLES */
Â  Â  Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
Â  Â  Â  Â  .modal-content { background: var(--card-bg-color); padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid var(--border-color); position: relative;}
Â  Â  Â  Â  .modal-message { font-size: 1.1em; margin-bottom: 25px; color: var(--text-color-primary); line-height: 1.6; }
Â  Â  Â  Â  .modal-buttons { display: flex; gap: 15px; justify-content: center; }
Â  Â  Â  Â  .modal-buttons .btn { width: auto; padding: 12px 20px;}
Â  Â  Â  Â  .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-color-secondary); }
Â  Â  Â  Â  .btn-confirm { background: linear-gradient(45deg, #27ae60, #2ecc71); }
Â  Â  Â  Â  .btn-cancel { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
Â  Â  Â  Â  #editTransactionModal .modal-content, #editHoldingModal .modal-content, #settingsModal .modal-content, #firebaseConfigModal .modal-content { text-align: left; }
Â  Â  Â  Â  #editTransactionModal .form-group, #editHoldingModal .form-group, #settingsModal .form-group { margin-bottom: 12px; }
Â  Â  Â  Â  #editHoldingModal .form-group small { color: var(--text-color-secondary); font-size: 0.8em; margin-top: 4px; display: block; }
Â  Â  Â  Â  #firebaseConfigModal .form-group { margin-bottom: 12px; }
Â  Â  Â  Â  #firebaseConfigModal .form-group label { font-size: 0.9em; }
Â  Â  Â  Â  #firebaseConfigModal .form-group input { font-size: 0.9em; padding: 10px; }
Â  Â  Â  Â  #firebaseConfigModal .modal-buttons .btn { flex-grow: 1; }
Â  Â  Â  Â  /* Consolidated Card Styles */
Â  Â  Â  Â  .investment-header-summary { text-align: right; }
Â  Â  Â  Â  .investment-item.consolidated .investment-details {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 1rem;
Â  Â  Â  Â  Â  Â  padding: 0 20px 20px 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .consolidated-summary, .consolidated-footer {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  background: var(--bg-color);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .summary-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  font-size: 0.95em;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  .summary-item span:first-child { color: var(--text-color-secondary); }
Â  Â  Â  Â  .summary-item span:last-child { font-weight: 600; }
Â  Â  Â  Â  .consolidated-footer .summary-item span:last-child { font-size: 1.1em; }
Â  Â  Â  Â  .purchase-breakdown h4 {
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  .purchase-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  [data-theme="dark"] .purchase-item { background-color: var(--input-bg-color); }
Â  Â  Â  Â  .purchase-item-actions .btn {
Â  Â  Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  Â  Â  min-height: 28px;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Transaction History Styles */
Â  Â  Â  Â  .transaction-history {
Â  Â  Â  Â  Â  Â  padding: 0 20px 20px 20px;
Â  Â  Â  Â  Â  Â  background-color: rgba(0,0,0,0.02);
Â  Â  Â  Â  }
Â  Â  Â  Â  .transaction-history-header {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  padding-top: 15px;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  border-top: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .transaction-history-header h4 { margin: 0; }
Â  Â  Â  Â  .transaction-table-container { display: none; margin-top: 10px;}
Â  Â  Â  Â  .transaction-history.expanded .transaction-table-container { display: block; }
Â  Â  Â  Â  .transaction-history .toggle-icon { transition: transform 0.2s ease; }
Â  Â  Â  Â  .transaction-history.expanded .toggle-icon { transform: rotate(90deg); }
Â  Â  Â  Â  .transaction-table { width: 100%; border-collapse: collapse; }
Â  Â  Â  Â  .transaction-table th, .transaction-table td {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .transaction-table th {
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--text-color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .transaction-actions .btn {
Â  Â  Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  margin: 0 2px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .countdown-timer {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.7);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  z-index: 1001;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  }

Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .container { padding: 15px; } .main-content { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .investment-header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; } .header { padding-top: 60px; } .data-status { position: static; margin: 0 auto 15px auto; display: block; width: fit-content; font-size: 0.75em; } .theme-toggle { top: 15px; left: 15px; } .pie-charts-container { grid-template-columns: 1fr; }
Â  Â  Â  Â  Â  Â  .refresh-button-container { text-align: center; }
Â  Â  Â  Â  Â  Â  .refresh-button-container .btn {Â 
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .stats-grid { grid-template-columns: 1fr; } #dataTransfer button { width: 100%; margin: 5px 0; } .controls-bar .form-group { width: 100%; }
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 992px) {
Â  Â  Â  Â  Â  Â  .investment-item:not(.consolidated) .investment-details {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(4, 1fr);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Styles for Auth and Collapse Button */
Â  Â  Â  Â  #auth-container { position: absolute; top: 10px; left: 60px; z-index: 10; display: flex; align-items: center; gap: 10px; }
Â  Â  Â  Â  #user-info { display: flex; align-items: center; gap: 10px; background: var(--card-bg-color); padding: 5px 10px; border-radius: 20px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px var(--shadow-color); }
Â  Â  Â  Â  #user-info img { width: 30px; height: 30px; border-radius: 50%; }
Â  Â  Â  Â  #user-info span { font-weight: 600; font-size: 0.9em; }
Â  Â  Â  Â  #signOutBtn { width: auto; font-size: 0.8em; padding: 6px 12px; background: #e74c3c; }
Â  Â  Â  Â  .collapse-group-btn {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin: 15px auto 0;
Â  Â  Â  Â  Â  Â  padding: 8px 16px;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  background: var(--bg-color);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  color: var(--text-color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .collapse-group-btn:hover { background: #e5e7eb; }
Â  Â  Â  Â  [data-theme="dark"] .collapse-group-btn:hover { background: #374151; }
Â  Â  </style>
</head>
<body>

Â  Â  <script type="module">
Â  Â  Â  Â  // Firebase App (the core Firebase SDK) is always required and must be listed first
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, setDoc, onSnapshot, collection, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

Â  Â  Â  Â  // --- GLOBAL APP STATE ---
Â  Â  Â  Â  const LOCAL_STORAGE_FIREBASE_CONFIG_KEY = 'myPortfolioFirebaseConfig_v4';
Â  Â  Â  Â  const FIRESTORE_DATA_DOC = 'portfolioData';
Â  Â  Â  Â  const FIRESTORE_UI_STATE_DOC = 'uiState';
Â  Â  Â  Â  const FIRESTORE_PRICE_CACHE_DOC = 'priceCache';

Â  Â  Â  Â  const THEME_KEY = 'myPortfolioTheme_v4';
Â  Â  Â  Â  const AUTO_REFRESH_STATE_KEY = 'myPortfolioAutoRefreshState_v4';
Â  Â  Â  Â  const FINNHUB_API_KEY_STORAGE = 'myPortfolioFinnhubKey_v4';
Â  Â  Â  Â  const ALPHA_VANTAGE_API_KEY_STORAGE = 'myPortfolioAlphaVantageKey_v4';
Â  Â  Â  Â  const FMP_API_KEY_STORAGE = 'myPortfolioFmpKey_v4'; // ADDED FMP KEY STORAGE
Â  Â  Â  Â  const REFRESH_INTERVAL_KEY = 'myPortfolioRefreshInterval_v4';
Â  Â  Â  Â  const CORS_PROXY = "https://corsproxy.io/?";

Â  Â  Â  Â  // --- API & Fetching Configuration ---
Â  Â  Â  Â  const API_THROTTLE_DELAY = 350; // ms to wait between API calls
Â  Â  Â  Â  const CACHE_STALE_TIME_FAST = 300 * 1000; // 5 minutes for Stocks, ETFs
Â  Â  Â  Â  const CACHE_STALE_TIME_SLOW = 12 * 60 * 60 * 1000; // 12 hours for Mutual Funds, etc.

Â  Â  Â  Â  let FINNHUB_API_KEY = 'd316lc1r01qnu2r0opjgd316lc1r01qnu2r0opk0';
Â  Â  Â  Â  let ALPHA_VANTAGE_API_KEY = '0ZPH51BZ2N5O9G8Q';
Â  Â  Â  Â  let FMP_API_KEY = 'vOqUU3gDIDYWghK8m4ZlsVQwLDnhfYMS'; // ADDED FMP KEY HARDCODED DEFAULT
Â  Â  Â  Â  const WATCHLIST_ACCOUNT_TYPE = 'Yahoo Finance';

Â  Â  Â  Â  let firebaseApp, db, auth, userId;
Â  Â  Â  Â  let unsubscribePortfolio, unsubscribeUiState, unsubscribePriceCache;

Â  Â  Â  Â  let portfolioData = {
Â  Â  Â  Â  Â  Â  Â username: '',
Â  Â  Â  Â  Â  Â  Â transactions: []
Â  Â  Â  Â  };
Â  Â  Â  Â  let uiState = {
Â  Â  Â  Â  Â  Â  expandedGroups: {},
Â  Â  Â  Â  Â  Â  expandedTransactions: {}
Â  Â  Â  Â  };
Â  Â  Â  Â  let priceCache = {};

Â  Â  Â  Â  let totalRealizedGainLoss = 0;
Â  Â  Â  Â  let isSymbolValidated = false;
Â  Â  Â  Â  let accountChart, investmentChart, historicalChart, dividendChart;
Â  Â  Â  Â  let isAddFormExpanded = false;
Â  Â  Â  Â  let countdownIntervalId = null;
Â  Â  Â  Â  let isAutoRefreshEnabled = true;
Â  Â  Â  Â  let autoRefreshIntervalSeconds = 300; // Default to the safer 5-minute interval
Â  Â  Â  Â  let currentSort = 'default';
Â  Â  Â  Â  let currentFilter = 'all';
Â  Â  Â  Â  let currentSearchTerm = '';
Â  Â  Â  Â  let activeChartFilter = 'All';
Â  Â  Â  Â  let validationTimeout = null;
Â  Â  Â  Â  let lastEditedField = 'shares';
Â  Â  Â  Â  let userNameUpdateTimeout = null;
Â  Â  Â  Â  let isInitialDataLoaded = false; // Prevents race conditions on load

Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  function handleConfigFileImport(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  const text = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const config = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const requiredKeys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startIndex = text.indexOf('{');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endIndex = text.lastIndexOf('}');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (startIndex === -1 || endIndex === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Could not find a configuration object { ... } in the file.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const content = text.substring(startIndex + 1, endIndex);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content.split(',').forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (line.trim() === '') return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parts = line.split(':');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parts.length < 2) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const key = parts[0].trim().replace(/['"]/g, '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let value = parts.slice(1).join(':').trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value = value.substring(1, value.length - 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (requiredKeys.includes(key)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  config[key] = value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hasAllKeys = requiredKeys.every(key => config[key]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!hasAllKeys) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("The configuration object is missing required Firebase keys. Please ensure the file contains the full `firebaseConfig` object.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(LOCAL_STORAGE_FIREBASE_CONFIG_KEY, JSON.stringify(config));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeFirebaseConfigModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("Failed to import configuration from file. Error: " + error.message, null);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  }

Â  Â  Â  Â  window.addEventListener('DOMContentLoaded', startApp);

Â  Â  Â  Â  async function startApp() {
Â  Â  Â  Â  Â  Â  document.getElementById('transactionDate').valueAsDate = new Date();
Â  Â  Â  Â  Â  Â  document.getElementById('firebaseConfigFileInput').addEventListener('change', handleConfigFileImport);
Â  Â  Â  Â  Â  Â  loadTheme();
Â  Â  Â  Â  Â  Â  loadApiKeys();
Â  Â  Â  Â  Â  Â  loadAutoRefreshInterval();
Â  Â  Â  Â  Â  Â  loadAutoRefreshState();
Â  Â  Â  Â  Â  Â  document.getElementById('sortOptions').addEventListener('change', e => { currentSort = e.target.value; updateDisplay(); });
Â  Â  Â  Â  Â  Â  document.getElementById('filterPlatform').addEventListener('change', e => { currentFilter = e.target.value; updateDisplay(); });
Â  Â  Â  Â  Â  Â  document.getElementById('searchInput').addEventListener('input', e => { currentSearchTerm = e.target.value; updateDisplay(); });
Â  Â  Â  Â  Â  Â  document.getElementById('csvFileInput').addEventListener('change', handleCsvImport);
Â  Â  Â  Â  Â  Â  document.getElementById('userNameInput').addEventListener('input', debouncedUpdateUserName);
Â  Â  Â  Â  Â  Â  document.getElementById('signInBtn').addEventListener('click', signInWithGoogle);
Â  Â  Â  Â  Â  Â  document.getElementById('signOutBtn').addEventListener('click', signOutUser);
Â  Â  Â  Â  Â  Â  await initializeFirebase();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function initializeFirebase() {
Â  Â  Â  Â  Â  Â  const storedConfig = localStorage.getItem(LOCAL_STORAGE_FIREBASE_CONFIG_KEY);
Â  Â  Â  Â  Â  Â  if (!storedConfig) {
Â  Â  Â  Â  Â  Â  Â  Â  showFirebaseConfigModal();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const firebaseConfig = JSON.parse(storedConfig);
Â  Â  Â  Â  Â  Â  Â  Â  firebaseApp = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(firebaseApp);
Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(firebaseApp);

Â  Â  Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const signInBtn = document.getElementById('signInBtn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userInfoDiv = document.getElementById('user-info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isInitialDataLoaded = false; // Reset on auth change
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (user && !user.isAnonymous) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signInBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userInfoDiv.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userName').textContent = user.displayName || 'User';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userPhoto').src = user.photoURL || 'https://placehold.co/30x30/6D28D9/FFFFFF?text=U';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setupFirestoreListeners();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateDataStatus(true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId = user?.uid; // Keep anonymous ID if exists
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signInBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userInfoDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await setupFirestoreListeners();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firebase initialization failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  updateDataStatus('error', "Config Error. Please Reset Connection.");
Â  Â  Â  Â  Â  Â  Â  Â  showFirebaseConfigModal(true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function signInWithGoogle() {
Â  Â  Â  Â  Â  Â  const provider = new GoogleAuthProvider();
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await signInWithPopup(auth, provider);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Google Sign-In Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal(`Could not sign in with Google. Error: ${error.message}`, null);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function signOutUser() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await signOut(auth);
Â  Â  Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Sign Out Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal(`Could not sign out. Error: ${error.message}`, null);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function setupFirestoreListeners() {
Â  Â  Â  Â  Â  Â  if (!userId) return;
Â  Â  Â  Â  Â  Â  if (unsubscribePortfolio) unsubscribePortfolio();
Â  Â  Â  Â  Â  Â  if (unsubscribeUiState) unsubscribeUiState();
Â  Â  Â  Â  Â  Â  if (unsubscribePriceCache) unsubscribePriceCache();

Â  Â  Â  Â  Â  Â  const userDocRef = doc(db, 'users', userId);
Â  Â  Â  Â  Â  Â  const portfolioColRef = collection(userDocRef, 'data');

Â  Â  Â  Â  Â  Â  const portfolioDocRef = doc(portfolioColRef, FIRESTORE_DATA_DOC);
Â  Â  Â  Â  Â  Â  unsubscribePortfolio = onSnapshot(portfolioDocRef, (docSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  portfolioData = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setDoc(portfolioDocRef, portfolioData);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  isInitialDataLoaded = true; // Set flag after first data load
Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  if (isAutoRefreshEnabled) startAutoRefresh(); else updateAutoRefreshButton();
Â  Â  Â  Â  Â  Â  }, (error) => console.error("Error listening to portfolio:", error));

Â  Â  Â  Â  Â  Â  const uiStateDocRef = doc(portfolioColRef, FIRESTORE_UI_STATE_DOC);
Â  Â  Â  Â  Â  Â  unsubscribeUiState = onSnapshot(uiStateDocRef, (docSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uiState = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const priceCacheDocRef = doc(portfolioColRef, FIRESTORE_PRICE_CACHE_DOC);
Â  Â  Â  Â  Â  Â  unsubscribePriceCache = onSnapshot(priceCacheDocRef, (docSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceCache = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- MODALS (Confirmation, Firebase Config, Edit, etc.) ---
Â  Â  Â  Â  function showConfirmationModal(message, onConfirm, onCancel) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('confirmationModal');
Â  Â  Â  Â  Â  Â  const messageEl = document.getElementById('modalMessage');
Â  Â  Â  Â  Â  Â  const confirmBtn = document.getElementById('modalConfirmBtn');
Â  Â  Â  Â  Â  Â  const cancelBtn = document.getElementById('modalCancelBtn');

Â  Â  Â  Â  Â  Â  messageEl.textContent = message;
Â  Â  Â  Â  Â  Â  modal.style.display = 'flex';

Â  Â  Â  Â  Â  Â  const newConfirmBtn = confirmBtn.cloneNode(true);
Â  Â  Â  Â  Â  Â  confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

Â  Â  Â  Â  Â  Â  const newCancelBtn = cancelBtn.cloneNode(true);
Â  Â  Â  Â  Â  Â  cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

Â  Â  Â  Â  Â  Â  if (onConfirm) {
Â  Â  Â  Â  Â  Â  Â  Â  newConfirmBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  newCancelBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  newConfirmBtn.textContent = 'Confirm';
Â  Â  Â  Â  Â  Â  Â  Â  newCancelBtn.textContent = 'Cancel';
Â  Â  Â  Â  Â  Â  Â  Â  newConfirmBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onConfirm();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  newCancelBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (onCancel) onCancel();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  newConfirmBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  newCancelBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  newConfirmBtn.textContent = 'OK';
Â  Â  Â  Â  Â  Â  Â  Â  newConfirmBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showFirebaseConfigModal(isErrorState = false) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('firebaseConfigModal');
Â  Â  Â  Â  Â  Â  const errorMsg = document.getElementById('firebaseConfigError');
Â  Â  Â  Â  Â  Â  errorMsg.style.display = isErrorState ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeFirebaseConfigModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('firebaseConfigModal').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  window.saveFirebaseConfig = function() {
Â  Â  Â  Â  Â  Â  const config = {
Â  Â  Â  Â  Â  Â  Â  Â  apiKey: document.getElementById('fbApiKey').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  authDomain: document.getElementById('fbAuthDomain').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  projectId: document.getElementById('fbProjectId').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  storageBucket: document.getElementById('fbStorageBucket').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  messagingSenderId: document.getElementById('fbMessagingSenderId').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  appId: document.getElementById('fbAppId').value.trim()
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  if (Object.values(config).some(v => !v)) {
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("All fields are required. Please check your values from the Firebase console.", null);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(LOCAL_STORAGE_FIREBASE_CONFIG_KEY, JSON.stringify(config));
Â  Â  Â  Â  Â  Â  Â  Â  closeFirebaseConfigModal();
Â  Â  Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("Failed to save configuration. Please try again.", null);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  window.resetFirebaseConnection = function() {
Â  Â  Â  Â  Â  Â  showConfirmationModal("Are you sure? This will clear your current connection settings and reload the page.", () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.removeItem(LOCAL_STORAGE_FIREBASE_CONFIG_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  Â location.reload();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Core Data Calculation Logic ---
Â  Â  Â  Â  function calculateHoldingsAndCash() {
Â  Â  Â  Â  Â  Â  const holdings = {};
Â  Â  Â  Â  Â  Â  let realizedGains = 0;
Â  Â  Â  Â  Â  Â  const sortedTransactions = [...(portfolioData.transactions || [])].sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
Â  Â  Â  Â  Â  Â  const taxLots = {};

Â  Â  Â  Â  Â  Â  sortedTransactions.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const shares = parseFloat(t.shares);
Â  Â  Â  Â  Â  Â  Â  Â  const price = parseFloat(t.price);
Â  Â  Â  Â  Â  Â  Â  Â  const type = t.transactionType.toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  const positionKey = `${t.symbol}|||${t.accountType}|||${t.platform}`;

Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'BUY') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!t.symbol || isNaN(shares) || isNaN(price)) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!taxLots[positionKey]) taxLots[positionKey] = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taxLots[positionKey].push({ shares, price, date: t.date, transaction: t });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === 'SELL') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!t.symbol || isNaN(shares) || isNaN(price)) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let sharesToSell = shares;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!taxLots[positionKey]) taxLots[positionKey] = [];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  while (sharesToSell > 0 && taxLots[positionKey].length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lot = taxLots[positionKey][0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sharesFromLot = Math.min(sharesToSell, lot.shares);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.accountType !== WATCHLIST_ACCOUNT_TYPE) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â realizedGains += sharesFromLot * (price - lot.price);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lot.shares -= sharesFromLot;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sharesToSell -= sharesFromLot;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lot.shares < 0.0001) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taxLots[positionKey].shift();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Object.entries(taxLots).forEach(([positionKey, lots]) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (lots.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let totalShares = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let totalCost = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lots.forEach(lot => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalShares += lot.shares;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCost += lot.shares * lot.price;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (totalShares > 0.00001) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const firstTransaction = lots[0].transaction;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const [symbol, accountType, platform] = positionKey.split('|||');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  holdings[positionKey] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symbol: symbol,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: firstTransaction.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: firstTransaction.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accountType: accountType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  platform: platform,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dividend: firstTransaction.dividend,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalShares: totalShares,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCost: totalCost,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  averagePurchasePrice: totalCost / totalShares,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transactions: portfolioData.transactions.filter(t => t.symbol === symbol && t.accountType === accountType && t.platform === platform)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  totalRealizedGainLoss = realizedGains;

Â  Â  Â  Â  Â  Â  const calculatedHoldings = Object.values(holdings).map(h => {
Â  Â  Â  Â  Â  Â  Â  Â  const cachedInfo = priceCache[h.symbol] || {};
Â  Â  Â  Â  Â  Â  Â  Â  if (isCashEquivalentType(h.type)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h.currentPrice = 1.0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else if (cachedInfo.manualPrice != null && cachedInfo.manualPrice >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h.currentPrice = cachedInfo.manualPrice;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (cachedInfo.currentPrice && cachedInfo.currentPrice > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h.currentPrice = cachedInfo.currentPrice;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h.currentPrice = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  h.previousClosePrice = cachedInfo.previousClosePrice || null;
Â  Â  Â  Â  Â  Â  Â  Â  return h;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return calculatedHoldings;
Â  Â  Â  Â  }

Â  Â  Â  Â  function buildPortfolioHistoryFromTransactions(holdings) {
Â  Â  Â  Â  Â  Â  const nonWatchlistTransactions = (portfolioData.transactions || []).filter(t => t.accountType !== WATCHLIST_ACCOUNT_TYPE);
Â  Â  Â  Â  Â  Â  if (nonWatchlistTransactions.length === 0) return [];

Â  Â  Â  Â  Â  Â  const dailySnapshots = {};
Â  Â  Â  Â  Â  Â  const sorted = [...nonWatchlistTransactions].sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
Â  Â  Â  Â  Â  Â  const allSymbols = [...new Set(sorted.filter(t => t.symbol && !t.symbol.startsWith('_CASH')).map(t => t.symbol))];

Â  Â  Â  Â  Â  Â  if (allSymbols.length === 0 && sorted.every(t => t.symbol.startsWith('_CASH'))) return [];

Â  Â  Â  Â  Â  Â  const firstDate = new Date(sorted[0].date);
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  let portfolioHistory = [];

Â  Â  Â  Â  Â  Â  for (let d = new Date(firstDate); d <= today; d.setDate(d.getDate() + 1)) {
Â  Â  Â  Â  Â  Â  Â  Â  const dateString = d.toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  const transactionsUpToDate = sorted.filter(t => new Date(t.date).toISOString().split('T')[0] <= dateString);

Â  Â  Â  Â  Â  Â  Â  Â  let dailyTotalValue = 0;
Â  Â  Â  Â  Â  Â  Â  Â  const tempHoldings = {};

Â  Â  Â  Â  Â  Â  Â  Â  transactionsUpToDate.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const shares = parseFloat(t.shares) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const price = parseFloat(t.price) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const type = t.transactionType.toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!t.symbol) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const symbol = t.symbol.toUpperCase();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!tempHoldings[symbol]) tempHoldings[symbol] = { totalShares: 0, totalCost: 0 };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'BUY') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempHoldings[symbol].totalShares += shares;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempHoldings[symbol].totalCost += shares * price;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === 'SELL') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tempHoldings[symbol].totalShares > 0) { // Avoid division by zero
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const avgCost = tempHoldings[symbol].totalCost / tempHoldings[symbol].totalShares;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempHoldings[symbol].totalCost -= shares * avgCost;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempHoldings[symbol].totalShares -= shares;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Object.entries(tempHoldings).forEach(([symbol, holding]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const avgCost = (holding.totalShares > 0) ? (holding.totalCost / holding.totalShares) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const price = priceCache[symbol]?.currentPrice || avgCost;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dailyTotalValue += holding.totalShares * price;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  dailySnapshots[dateString] = dailyTotalValue;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  portfolioHistory = Object.entries(dailySnapshots).map(([date, value]) => ({ date, value }));
Â  Â  Â  Â  Â  Â  return portfolioHistory;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Data Persistence Functions ---
Â  Â  Â  Â  function getCleanObject(obj) {
Â  Â  Â  Â  Â  Â  return JSON.parse(JSON.stringify(obj));
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveDataToFirestore() {
Â  Â  Â  Â  Â  Â  if (!isInitialDataLoaded || !userId) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Data not fully loaded yet. Save operation skipped.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const userDocRef = doc(db, 'users', userId);
Â  Â  Â  Â  Â  Â  Â  Â  const portfolioColRef = collection(userDocRef, 'data');
Â  Â  Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);

Â  Â  Â  Â  Â  Â  Â  Â  batch.set(doc(portfolioColRef, FIRESTORE_DATA_DOC), getCleanObject(portfolioData));
Â  Â  Â  Â  Â  Â  Â  Â  batch.set(doc(portfolioColRef, FIRESTORE_UI_STATE_DOC), getCleanObject(uiState));
Â  Â  Â  Â  Â  Â  Â  Â  batch.set(doc(portfolioColRef, FIRESTORE_PRICE_CACHE_DOC), getCleanObject(priceCache));

Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  updateDataStatus(true);
Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error saving to Firestore:", e);
Â  Â  Â  Â  Â  Â  Â  Â  updateDataStatus('error', "Save Failed");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function clearAllData() {
Â  Â  Â  Â  Â  Â  showConfirmationModal('Are you sure you want to clear ALL transaction data from the cloud? This cannot be undone.', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!userId) return;

Â  Â  Â  Â  Â  Â  Â  Â  portfolioData = { username: '', transactions: [] };
Â  Â  Â  Â  Â  Â  Â  Â  uiState = { expandedGroups: {}, expandedTransactions: {} };
Â  Â  Â  Â  Â  Â  Â  Â  priceCache = {};

Â  Â  Â  Â  Â  Â  Â  Â  const userDocRef = doc(db, 'users', userId);
Â  Â  Â  Â  Â  Â  Â  Â  const portfolioColRef = collection(userDocRef, 'data');
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(portfolioColRef, FIRESTORE_DATA_DOC), portfolioData);
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(portfolioColRef, FIRESTORE_UI_STATE_DOC), uiState);
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(portfolioColRef, FIRESTORE_PRICE_CACHE_DOC), priceCache);

Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  updateDataStatus(false, "Data cleared");
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- API & Price Fetching ---
Â  Â  Â  Â  const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

Â  Â  Â  Â  function loadApiKeys() {
Â  Â  Â  Â  Â  Â  FINNHUB_API_KEY = localStorage.getItem(FINNHUB_API_KEY_STORAGE) || 'd316lc1r01qnu2r0opjgd316lc1r01qnu2r0opk0';
Â  Â  Â  Â  Â  Â  ALPHA_VANTAGE_API_KEY = localStorage.getItem(ALPHA_VANTAGE_API_KEY_STORAGE) || '0ZPH51BZ2N5O9G8Q';
Â  Â  Â  Â  Â  Â  FMP_API_KEY = localStorage.getItem(FMP_API_KEY_STORAGE) || 'vOqUU3gDIDYWghK8m4ZlsVQwLDnhfYMS'; // Load new FMP key
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadAutoRefreshInterval() {
Â  Â  Â  Â  Â  Â  const storedInterval = localStorage.getItem(REFRESH_INTERVAL_KEY);
Â  Â  Â  Â  Â  Â  autoRefreshIntervalSeconds = storedInterval ? parseInt(storedInterval, 10) : 300;
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveSettings() {
Â  Â  Â  Â  Â  Â  FINNHUB_API_KEY = document.getElementById('finnhubApiKeyInput').value.trim();
Â  Â  Â  Â  Â  Â  ALPHA_VANTAGE_API_KEY = document.getElementById('alphaVantageApiKeyInput').value.trim();
Â  Â  Â  Â  Â  Â  FMP_API_KEY = document.getElementById('fmpApiKeyInput').value.trim(); // Save new FMP key
Â  Â  Â  Â  Â  Â  let newInterval = parseInt(document.getElementById('autoRefreshIntervalInput').value.trim(), 10);

Â  Â  Â  Â  Â  Â  if (isNaN(newInterval) || newInterval < 30) {
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("Invalid interval. Please enter a number that is 30 or greater.", null);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  autoRefreshIntervalSeconds = newInterval;
Â  Â  Â  Â  Â  Â  localStorage.setItem(FINNHUB_API_KEY_STORAGE, FINNHUB_API_KEY);
Â  Â  Â  Â  Â  Â  localStorage.setItem(ALPHA_VANTAGE_API_KEY_STORAGE, ALPHA_VANTAGE_API_KEY);
Â  Â  Â  Â  Â  Â  localStorage.setItem(FMP_API_KEY_STORAGE, FMP_API_KEY); // Save FMP key
Â  Â  Â  Â  Â  Â  localStorage.setItem(REFRESH_INTERVAL_KEY, autoRefreshIntervalSeconds);

Â  Â  Â  Â  Â  Â  showConfirmationModal("Settings have been saved successfully.", null);
Â  Â  Â  Â  Â  Â  closeSettingsModal();

Â  Â  Â  Â  Â  Â  stopAutoRefresh();
Â  Â  Â  Â  Â  Â  startAutoRefresh();
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
		 * FIXED: This function was rewritten to be more robust.
		 * Instead of relying on holding.type, it attempts to fetch a price from all available APIs
		 * in a "waterfall" sequence. This prevents failures if an asset is miscategorized
		 * (e.g., a mutual fund like FXAIX is logged as a "Stock").
		 * @param {object} holding The holding object.
		 * @returns {object} Price data object.
		 */
Â  Â  Â  Â  async function fetchPrice(holding) {
Â  Â  Â  Â  Â  Â  if (isCashEquivalentType(holding.type)) {
Â  Â  Â  Â  Â  Â  Â  Â  return { currentPrice: 1.0, previousClosePrice: 1.0 };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const symbol = holding.symbol;

Â  Â  Â  Â  Â  Â  // --- Waterfall Approach ---
Â  Â  Â  Â  Â  Â  // Attempt 1: Finnhub (Best for Stocks/ETFs, but fails for many mutual funds)
Â  Â  Â  Â  Â  Â  let priceData = await fetchPriceFromFinnhub(symbol);
Â  Â  Â  Â  Â  Â  if (priceData && priceData.currentPrice > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Price for ${symbol} found via Finnhub.`);
Â  Â  Â  Â  Â  Â  Â  Â  return priceData;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Attempt 2: FMP (Good for many funds, fallback for stocks)
Â  Â  Â  Â  Â  Â  await delay(API_THROTTLE_DELAY); // Wait before next API call to avoid rate limits
Â  Â  Â  Â  Â  Â  priceData = await fetchPriceFromFMP(symbol);
Â  Â  Â  Â  Â  Â  if (priceData && priceData.currentPrice > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Price for ${symbol} found via FMP.`);
Â  Â  Â  Â  Â  Â  Â  Â  return priceData;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Attempt 3: Alpha Vantage (Slowest, but good fallback for funds FMP misses)
Â  Â  Â  Â  Â  Â  await delay(API_THROTTLE_DELAY);
Â  Â  Â  Â  Â  Â  priceData = await fetchPriceFromAlphaVantage(symbol);
Â  Â  Â  Â  Â  Â  if (priceData && priceData.currentPrice > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Price for ${symbol} found via Alpha Vantage.`);
Â  Â  Â  Â  Â  Â  Â  Â  return priceData;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  console.warn(`All price providers failed for symbol: ${symbol}`);
Â  Â  Â  Â  Â  Â  return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  }

Â  Â  Â  Â  async function refreshAllPrices(forceRefresh = false) {
Â  Â  Â  Â  Â  Â  if (!isInitialDataLoaded) return;
Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  if (currentHoldings.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const refreshButton = document.querySelector('.refresh-button-container .btn:last-child');
Â  Â  Â  Â  Â  Â  refreshButton.textContent = 'Refreshing...';
Â  Â  Â  Â  Â  Â  refreshButton.disabled = true;
Â  Â  Â  Â  Â  Â  updateDataStatus('loading');

Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  for (const holding of currentHoldings) {
Â  Â  Â  Â  Â  Â  Â  Â  if (holding.type === 'Manual') continue;

Â  Â  Â  Â  Â  Â  Â  Â  const cached = priceCache[holding.symbol];
Â  Â  Â  Â  Â  Â  Â  Â  const isFastMoving = holding.type === 'Stock' || holding.type === 'ETF';
Â  Â  Â  Â  Â  Â  Â  Â  const staleTime = isFastMoving ? CACHE_STALE_TIME_FAST : CACHE_STALE_TIME_SLOW;

Â  Â  Â  Â  Â  Â  Â  Â  if (forceRefresh && !isFastMoving && cached && (now - cached.lastFetchTimestamp < staleTime)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Skipping forced refresh for slow asset ${holding.symbol} due to fresh cache.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (!forceRefresh && cached && (now - cached.lastFetchTimestamp < staleTime)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Using fresh cached price for ${holding.symbol}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  await delay(API_THROTTLE_DELAY);
Â  Â  Â  Â  Â  Â  Â  Â  const priceData = await fetchPrice(holding);
Â  Â  Â  Â  Â  Â  Â  Â  if (priceData && priceData.currentPrice !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!priceCache[holding.symbol]) priceCache[holding.symbol] = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceCache[holding.symbol].currentPrice = priceData.currentPrice;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceCache[holding.symbol].previousClosePrice = priceData.previousClosePrice;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceCache[holding.symbol].lastFetchTimestamp = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  refreshButton.textContent = 'Refresh Now';
Â  Â  Â  Â  Â  Â  refreshButton.disabled = false;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function validateWithAlphaVantage(symbol) {
Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('symbolValidationStatus');
Â  Â  Â  Â  Â  Â  if (!ALPHA_VANTAGE_API_KEY) {
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âš ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'Alpha Vantage API Key is missing for mutual fund lookup.';
Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = false;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const url = `${CORS_PROXY}https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (data.Information || data.Note) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âš ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'Alpha Vantage API limit reached (25/day). Please try again tomorrow or use a premium key.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const match = data.bestMatches?.find(item => item['1. symbol'] === symbol);
Â  Â  Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = `Validated: ${match['2. name']}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('name').value = match['2. name'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (match['3. type'] === 'Mutual Fund') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('type').value = 'Mutual Fund';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âŒ';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'Symbol not found on Finnhub or Alpha Vantage.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Alpha Vantage validation error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âš ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'API Error during Alpha Vantage validation.';
Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function validateSymbol() {
Â  Â  Â  Â  Â  Â  clearTimeout(validationTimeout);
Â  Â  Â  Â  Â  Â  validationTimeout = setTimeout(async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const symbol = document.getElementById('symbol').value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('symbolValidationStatus');
Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = false;

Â  Â  Â  Â  Â  Â  Â  Â  if (!symbol) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = '...';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'Validating...';

Â  Â  Â  Â  Â  Â  Â  Â  const mmRegex = /^[A-Z]{3,5}XX$/;
Â  Â  Â  Â  Â  Â  Â  Â  if (mmRegex.test(symbol)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('type').value = 'Money Market';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!FINNHUB_API_KEY) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âš ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'Finnhub API Key is missing.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const url = `${CORS_PROXY}https://finnhub.io/api/v1/search?q=${symbol}&token=${FINNHUB_API_KEY}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 429) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âš ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'Finnhub API limit reached. Please wait a moment and try again, or use a premium key.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorText = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("CORS/Network Error:", errorText);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âš ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = `Network Error: ${response.statusText}. The proxy service may be down.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const match = data.result?.find(item => item.symbol === symbol);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = `Validated: ${match.description}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('name').value = match.description.split(' ').slice(0, 3).join(' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (match.description.toUpperCase().includes('MONEY MARKET')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('type').value = 'Money Market';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await validateWithAlphaVantage(symbol);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Symbol validation error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âš ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'API Error during validation. Check the browser console for details.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 750);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Form Interaction Logic ---
Â  Â  Â  Â  function updateTransactionFields(editedField) {
Â  Â  Â  Â  Â  Â  const sharesInput = document.getElementById('shares');
Â  Â  Â  Â  Â  Â  const priceInput = document.getElementById('price');
Â  Â  Â  Â  Â  Â  const amountInput = document.getElementById('totalAmount');

Â  Â  Â  Â  Â  Â  if (editedField === 'shares' || editedField === 'price') {
Â  Â  Â  Â  Â  Â  Â  Â  lastEditedField = 'shares';
Â  Â  Â  Â  Â  Â  } else if (editedField === 'amount') {
Â  Â  Â  Â  Â  Â  Â  Â  lastEditedField = 'amount';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const shares = parseFloat(sharesInput.value);
Â  Â  Â  Â  Â  Â  const price = parseFloat(priceInput.value);
Â  Â  Â  Â  Â  Â  const amount = parseFloat(amountInput.value);

Â  Â  Â  Â  Â  Â  if (lastEditedField === 'shares') {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(shares) && !isNaN(price) && price > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amountInput.value = (shares * price).toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (sharesInput.value === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amountInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â if (!isNaN(amount) && !isNaN(price) && price > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sharesInput.value = (amount / price).toFixed(8);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (amountInput.value === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sharesInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Transaction CRUD Operations ---
Â  Â  Â  Â  function logTransaction() {
Â  Â  Â  Â  Â  Â  const transactionType = document.getElementById('transactionType').value;
Â  Â  Â  Â  Â  Â  const accountType = document.getElementById('accountType').value;
Â  Â  Â  Â  Â  Â  const symbol = document.getElementById('symbol').value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  const type = document.getElementById('type').value;

Â  Â  Â  Â  Â  Â  if (!accountType || !document.getElementById('platform').value) {
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("Account Type and Platform are required for all transactions.", null);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if ((transactionType === 'BUY' || transactionType === 'SELL' || transactionType === 'DIVIDEND' || transactionType === 'DEPOSIT' || transactionType === 'WITHDRAWAL') && !symbol) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showConfirmationModal('Symbol is required for this transaction type.', null);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (type !== 'Manual' && !isSymbolValidated && accountType !== '529 College Saving' && (transactionType === 'BUY' || transactionType === 'SELL' || transactionType === 'DIVIDEND')) {
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `Symbol "${symbol}" is not validated. This could be due to API limits or an untracked asset. Do you want to log this transaction anyway?`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  () => { // onConfirm
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('symbolValidationStatus');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'âœï¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.title = 'Manually added';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSymbolValidated = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  proceedWithTransactionLogging();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  proceedWithTransactionLogging();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function proceedWithTransactionLogging() {
Â  Â  Â  Â  Â  Â  const transactionType = document.getElementById('transactionType').value;
Â  Â  Â  Â  Â  Â  const accountType = document.getElementById('accountType').value;
Â  Â  Â  Â  Â  Â  const platform = document.getElementById('platform').value;
Â  Â  Â  Â  Â  Â  const type = document.getElementById('type').value;
Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  const transactionsToAdd = [];
Â  Â  Â  Â  Â  Â  let mainTransaction = {
Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now(),
Â  Â  Â  Â  Â  Â  Â  Â  transactionType: transactionType,
Â  Â  Â  Â  Â  Â  Â  Â  date: document.getElementById('transactionDate').value,
Â  Â  Â  Â  Â  Â  Â  Â  accountType: accountType,
Â  Â  Â  Â  Â  Â  Â  Â  platform: platform,
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  if (transactionType === 'DEPOSIT' || transactionType === 'WITHDRAWAL') {
Â  Â  Â  Â  Â  Â  Â  Â  const amount = parseFloat(document.getElementById('amount').value);
Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(amount) || amount <= 0) { showConfirmationModal("Please enter a valid amount.", null); return; }

Â  Â  Â  Â  Â  Â  Â  Â  const symbol = document.getElementById('symbol').value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  mainTransaction.transactionType = (transactionType === 'DEPOSIT') ? 'BUY' : 'SELL';
Â  Â  Â  Â  Â  Â  Â  Â  mainTransaction.symbol = symbol;
Â  Â  Â  Â  Â  Â  Â  Â  mainTransaction.name = document.getElementById('name').value.trim() || symbol;
Â  Â  Â  Â  Â  Â  Â  Â  mainTransaction.shares = amount; // For cash funds, amount = shares
Â  Â  Â  Â  Â  Â  Â  Â  mainTransaction.price = 1;
Â  Â  Â  Â  Â  Â  Â  Â  mainTransaction.type = 'CASH'; // Assume deposits/withdrawals are cash-equivalents
Â  Â  Â  Â  Â  Â  Â  Â  transactionsToAdd.push(mainTransaction);
Â  Â  Â  Â  Â  Â  } else { // BUY, SELL, DIVIDEND
Â  Â  Â  Â  Â  Â  Â  Â  const symbol = document.getElementById('symbol').value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  const shares = parseFloat(document.getElementById('shares').value);
Â  Â  Â  Â  Â  Â  Â  Â  const price = parseFloat(document.getElementById('price').value);
Â  Â  Â  Â  Â  Â  Â  Â  const cost = shares * price;
Â  Â  Â  Â  Â  Â  Â  Â  if ((transactionType === 'BUY' || transactionType === 'SELL') && (!symbol || isNaN(shares) || shares <= 0 || isNaN(price) || price < 0)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("Symbol, Shares, and Price must be valid positive numbers.", null); return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if(transactionType === 'DIVIDEND') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const amount = parseFloat(document.getElementById('amount').value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (isNaN(amount) || amount <= 0) { showConfirmationModal("Please enter a valid dividend amount.", null); return; }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const cashFund = currentHoldings.find(h => h.accountType === accountType && h.platform === platform && isCashEquivalentType(h.type));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (cashFund) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mainTransaction.transactionType = 'BUY';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mainTransaction.symbol = cashFund.symbol;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mainTransaction.name = `Dividend from ${document.getElementById('symbol').value.trim().toUpperCase()}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mainTransaction.shares = amount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mainTransaction.price = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mainTransaction.type = cashFund.type;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â transactionsToAdd.push(mainTransaction);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showConfirmationModal(`No cash/money market fund found in ${accountType} on ${platform} to deposit dividend. Please add a cash fund (e.g., SPAXX) first.`, null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  } else { // BUY or SELL
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(mainTransaction, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symbol: symbol, name: document.getElementById('name').value.trim() || symbol, shares: shares, price: price,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dividend: parseFloat(document.getElementById('dividend').value) || 0, type: type
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transactionsToAdd.push(mainTransaction);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const isMoneyMarket = isCashEquivalentType(type);
Â  Â  Â  Â  Â  Â  Â  Â  const isRetirementOr529 = accountType === '401(k)' || accountType === '529 College Saving';
Â  Â  Â  Â  Â  Â  Â  Â  if (transactionType === 'BUY' && !isMoneyMarket && !isRetirementOr529 && accountType !== WATCHLIST_ACCOUNT_TYPE) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fundingAccountType = accountType;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fundingPlatform = platform;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cashAndMoneyMarketHoldings = currentHoldings.filter(h =>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â h.accountType === fundingAccountType &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â h.platform === fundingPlatform &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isCashEquivalentType(h.type)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const availableCash = cashAndMoneyMarketHoldings.reduce((sum, h) => sum + (Number(h.totalShares) || 0), 0);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (availableCash < cost) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal(`Transaction Failed: Insufficient buying power in ${fundingAccountType} on ${fundingPlatform}. This purchase costs ${formatCurrency(cost)}, but you only have ${formatCurrency(availableCash)} available. Please log a DEPOSIT transaction first.`, null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sourceFund = cashAndMoneyMarketHoldings.sort((a,b) => b.totalShares - a.totalShares)[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sourceFund) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transactionsToAdd.unshift({ // Add SELL to the beginning of the list to be processed first
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now() - 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transactionType: 'SELL', date: mainTransaction.date, accountType: fundingAccountType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  platform: sourceFund.platform, symbol: sourceFund.symbol, name: sourceFund.name, shares: cost, price: 1, type: sourceFund.type
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â if(transactionType === 'SELL' && !isMoneyMarket && !isRetirementOr529) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const cashFund = currentHoldings.find(h => h.accountType === accountType && h.platform === platform && isCashEquivalentType(h.type));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (cashFund) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â transactionsToAdd.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id: Date.now() + 1, transactionType: 'BUY', date: mainTransaction.date, accountType: accountType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â platform: cashFund.platform, symbol: cashFund.symbol, name: cashFund.name, shares: cost, price: 1, type: cashFund.type
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  portfolioData.transactions.push(...transactionsToAdd);
Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  clearForm();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function removeTransaction(id) {
Â  Â  Â  Â  Â  Â  showConfirmationModal('Are you sure you want to remove this transaction?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  portfolioData.transactions = portfolioData.transactions.filter(t => t.id != id);
Â  Â  Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async function removeHolding(symbol, accountType, platform) {
Â  Â  Â  Â  Â  Â  showConfirmationModal(`Are you sure you want to delete ${symbol} from ${accountType} - ${platform} and all its associated transactions? This cannot be undone.`, async () => {
Â  Â  Â  Â  Â  Â  Â  Â  portfolioData.transactions = portfolioData.transactions.filter(t => !(t.symbol === symbol && t.accountType === accountType && t.platform === platform));
Â  Â  Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearForm() {
Â  Â  Â  Â  Â  Â  document.getElementById('symbol').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('name').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('shares').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('price').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('amount').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('totalAmount').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('symbolValidationStatus').textContent = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  async function toggleGroup(groupName, shouldScroll = false) {
Â  Â  Â  Â  Â  Â  uiState.expandedGroups[groupName] = !uiState.expandedGroups[groupName];
Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  if (shouldScroll) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const groupHeader = document.getElementById(`group-${groupName.replace(/\s+/g, '-')}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (groupHeader) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groupHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

		async function toggleAddForm() {
Â  Â  Â  Â  Â  Â  isAddFormExpanded = !isAddFormExpanded;
Â  Â  Â  Â  Â  Â  document.getElementById('addFormContent').style.display = isAddFormExpanded ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('addFormToggleIcon').innerHTML = isAddFormExpanded ? '&#9660;' : '&#9658;';
Â  Â  Â  Â  Â  Â  // This is local-only state, not synced.
Â  Â  Â  Â  }

Â  Â  Â  Â  function openSettingsModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('finnhubApiKeyInput').value = FINNHUB_API_KEY;
Â  Â  Â  Â  Â  Â  document.getElementById('alphaVantageApiKeyInput').value = ALPHA_VANTAGE_API_KEY;
Â  Â  Â  Â  Â  Â  document.getElementById('fmpApiKeyInput').value = FMP_API_KEY; // Populate FMP key
Â  Â  Â  Â  Â  Â  document.getElementById('autoRefreshIntervalInput').value = autoRefreshIntervalSeconds;
Â  Â  Â  Â  Â  Â  document.getElementById('settingsModal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeSettingsModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('settingsModal').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleAccountTypeChange() {
Â  Â  Â  Â  Â  Â  const accountType = document.getElementById('accountType').value;
Â  Â  Â  Â  Â  Â  const transactionTypeValue = document.getElementById('transactionType').value;
Â  Â  Â  Â  Â  Â  const fundingGroup = document.getElementById('fundingSourceGroup');

Â  Â  Â  Â  Â  Â  if (accountType === '529 College Saving' && transactionTypeValue === 'BUY') {
Â  Â  Â  Â  Â  Â  Â  Â  populateFundingSources();
Â  Â  Â  Â  Â  Â  Â  Â  fundingGroup.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  fundingGroup.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function populateFundingSources() {
Â  Â  Â  Â  Â  Â  const fundingSelect = document.getElementById('fundingSource');
Â  Â  Â  Â  Â  Â  fundingSelect.innerHTML = '';
Â  Â  Â  Â  Â  Â  const allAccounts = [...new Set(portfolioData.transactions.map(t => t.accountType))];
Â  Â  Â  Â  Â  Â  const fundableAccounts = allAccounts.filter(acc => acc === 'Regular Brokerage');

Â  Â  Â  Â  Â  Â  if(fundableAccounts.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â fundableAccounts.forEach(acc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  option.value = acc;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  option.textContent = acc;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fundingSelect.appendChild(option);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  option.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  option.textContent = 'No Brokerage account to fund from';
Â  Â  Â  Â  Â  Â  Â  Â  fundingSelect.appendChild(option);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleTransactionFields() {
Â  Â  Â  Â  Â  Â  const type = document.getElementById('transactionType').value;
Â  Â  Â  Â  Â  Â  const cashFields = document.querySelectorAll('.cash-field');
Â  Â  Â  Â  Â  Â  const transactionFields = document.querySelectorAll('.transaction-field');
Â  Â  Â  Â  Â  Â  const buySellFields = document.querySelectorAll('.buy-sell-field');

Â  Â  Â  Â  Â  Â  if (type === 'DEPOSIT' || type === 'WITHDRAWAL') {
Â  Â  Â  Â  Â  Â  Â  Â  cashFields.forEach(f => f.style.display = 'block');
Â  Â  Â  Â  Â  Â  Â  Â  buySellFields.forEach(f => f.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('symbol').parentElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('name').parentElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else if (type === 'DIVIDEND') {
Â  Â  Â  Â  Â  Â  Â  Â  cashFields.forEach(f => f.style.display = 'block');
Â  Â  Â  Â  Â  Â  Â  Â  buySellFields.forEach(f => f.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('symbol').parentElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('name').parentElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else { // BUY or SELL
Â  Â  Â  Â  Â  Â  Â  Â  cashFields.forEach(f => f.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  transactionFields.forEach(f => f.style.display = 'block');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  handleAccountTypeChange();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Calculation and Rendering Logic ---
Â  Â  Â  Â  function isCashEquivalentType(type) {
Â  Â  Â  Â  Â  Â  if (!type) return false;
Â  Â  Â  Â  Â  Â  const t = String(type).trim().toLowerCase();
Â  Â  Â  Â  Â  Â  const normalized = t.replace(/[^a-z0-9]/g, '');
Â  Â  Â  Â  Â  Â  const isCash = normalized === 'cash' || normalized === 'moneymarket' || normalized === 'mm' || t.includes('cash') || (t.includes('money') && t.includes('market'));
Â  Â  Â  Â  Â  Â  // console.log(`Checking if '${type}' is cash: ${isCash}`); // Log to check logic
Â  Â  Â  Â  Â  Â  return isCash;
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateOverallStats(portfolioHoldings) {
Â  Â  Â  Â  Â  Â  let totalCostBasis = 0;
Â  Â  Â  Â  Â  Â  let totalValue = 0;
Â  Â  Â  Â  Â  Â  let totalCashValue = 0;
Â  Â  Â  Â  Â  Â  let totalDailyGainLoss = 0;
Â  Â  Â  Â  Â  Â  let estimatedAnnualIncome = 0;
Â  Â  Â  Â  Â  Â  let bestPerformer = { symbol: 'N/A', gain: -Infinity };
Â  Â  Â  Â  Â  Â  let worstPerformer = { symbol: 'N/A', gain: Infinity };

Â  Â  Â  Â  Â  Â  const filteredHoldings = portfolioHoldings.filter(h => h.accountType !== WATCHLIST_ACCOUNT_TYPE);

Â  Â  Â  Â  Â  Â  filteredHoldings.forEach(h => {
Â  Â  Â  Â  Â  Â  Â  Â  const isCashEquivalent = isCashEquivalentType(h.type);
Â  Â  Â  Â  Â  Â  Â  Â  const displayPrice = h.currentPrice || h.averagePurchasePrice;
Â  Â  Â  Â  Â  Â  Â  Â  const currentValue = (Number(h.totalShares) || 0) * displayPrice;
Â  Â  Â  Â  Â  Â  Â  Â  totalValue += currentValue;

Â  Â  Â  Â  Â  Â  Â  Â  if (isCashEquivalent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCashValue += currentValue;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCostBasis += Number(h.totalCost) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  estimatedAnnualIncome += (Number(h.dividend) || 0) * (Number(h.totalShares) || 0);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (h.currentPrice !== null && h.currentPrice > 0 && h.previousClosePrice > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDailyGainLoss += (currentValue - ((Number(h.totalShares) || 0) * h.previousClosePrice));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const unrealizedGain = currentValue - (Number(h.totalCost) || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (unrealizedGain > bestPerformer.gain) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bestPerformer = { symbol: h.symbol, gain: unrealizedGain };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (unrealizedGain < worstPerformer.gain) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  worstPerformer = { symbol: h.symbol, gain: unrealizedGain };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const investedAssetsValue = filteredHoldings
Â  Â  Â  Â  Â  Â  Â  Â  .filter(h => !isCashEquivalentType(h.type))
Â  Â  Â  Â  Â  Â  Â  Â  .reduce((sum, h) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const displayPrice = h.currentPrice || h.averagePurchasePrice;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return sum + ((Number(h.totalShares) || 0) * displayPrice);
Â  Â  Â  Â  Â  Â  Â  Â  }, 0);

Â  Â  Â  Â  Â  Â  const totalUnrealizedGainLoss = investedAssetsValue - totalCostBasis;

Â  Â  Â  Â  Â  Â  return { totalCostBasis, totalValue, totalCashValue, totalUnrealizedGainLoss, totalDailyGainLoss, estimatedAnnualIncome, portfolioYieldOnCost: totalCostBasis > 0 ? estimatedAnnualIncome / totalCostBasis : 0, bestPerformer, worstPerformer };
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateStats(stats) {
Â  Â  Â  Â  Â  Â  document.getElementById('totalValue').textContent = formatCurrency(stats.totalValue);
Â  Â  Â  Â  Â  Â  document.getElementById('totalInvested').textContent = formatCurrency(stats.totalCostBasis);
Â  Â  Â  Â  Â  Â  document.getElementById('totalCashValue').textContent = formatCurrency(stats.totalCashValue);
Â  Â  Â  Â  Â  Â  const unrealizedEl = document.getElementById('unrealizedGainLoss');
Â  Â  Â  Â  Â  Â  unrealizedEl.textContent = formatCurrency(stats.totalUnrealizedGainLoss);
Â  Â  Â  Â  Â  Â  unrealizedEl.className = 'stat-value ' + (stats.totalUnrealizedGainLoss >= 0 ? 'positive' : 'negative');
Â  Â  Â  Â  Â  Â  const realizedEl = document.getElementById('realizedGainLoss');
Â  Â  Â  Â  Â  Â  realizedEl.textContent = formatCurrency(totalRealizedGainLoss);
Â  Â  Â  Â  Â  Â  realizedEl.className = 'stat-value ' + (totalRealizedGainLoss >= 0 ? 'positive' : 'negative');
Â  Â  Â  Â  Â  Â  const todayEl = document.getElementById('todayPortfolioGainLoss');
Â  Â  Â  Â  Â  Â  todayEl.textContent = formatCurrency(stats.totalDailyGainLoss);
Â  Â  Â  Â  Â  Â  todayEl.className = 'stat-value ' + (stats.totalDailyGainLoss >= 0 ? 'positive' : 'negative');
Â  Â  Â  Â  Â  Â  document.getElementById('estimatedAnnualIncome').textContent = formatCurrency(stats.estimatedAnnualIncome);
Â  Â  Â  Â  Â  Â  document.getElementById('portfolioYieldOnCost').textContent = formatPercentage(stats.portfolioYieldOnCost);
Â  Â  Â  Â  Â  Â  document.getElementById('bestPerformerValue').textContent = formatCurrency(stats.bestPerformer.gain);
Â  Â  Â  Â  Â  Â  document.getElementById('bestPerformerSymbol').textContent = stats.bestPerformer.symbol;
Â  Â  Â  Â  Â  Â  document.getElementById('bestPerformerValue').className = 'stat-value ' + (stats.bestPerformer.gain >= 0 ? 'positive' : 'negative');
Â  Â  Â  Â  Â  Â  document.getElementById('worstPerformerValue').textContent = formatCurrency(stats.worstPerformer.gain);
Â  Â  Â  Â  Â  Â  document.getElementById('worstPerformerSymbol').textContent = stats.worstPerformer.symbol;
Â  Â  Â  Â  Â  Â  document.getElementById('worstPerformerValue').className = 'stat-value ' + (stats.worstPerformer.gain >= 0 ? 'positive' : 'negative');
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderInvestments(holdings) {
Â  Â  Â  Â  Â  Â  if (!holdings) return;
Â  Â  Â  Â  Â  Â  const container = document.getElementById('investmentsList');
Â  Â  Â  Â  Â  Â  container.innerHTML = '';

Â  Â  Â  Â  Â  Â  let holdingsToRender = [...holdings];
Â  Â  Â  Â  Â  Â  const searchTerm = currentSearchTerm.toLowerCase();

Â  Â  Â  Â  Â  Â  if (searchTerm) {
Â  Â  Â  Â  Â  Â  Â  Â  holdingsToRender = holdingsToRender.filter(h =>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â h.symbol.toLowerCase().includes(searchTerm) || h.name.toLowerCase().includes(searchTerm)
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (currentFilter !== 'all') {
Â  Â  Â  Â  Â  Â  Â  Â  holdingsToRender = holdingsToRender.filter(h => h.platform === currentFilter);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const groupedByAccount = {};
Â  Â  Â  Â  Â  Â  holdingsToRender.forEach(h => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!groupedByAccount[h.accountType]) groupedByAccount[h.accountType] = [];
Â  Â  Â  Â  Â  Â  Â  Â  groupedByAccount[h.accountType].push(h);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const accountOrder = ['Regular Brokerage', 'Roth IRA', '401(k)', '529 College Saving', 'Yahoo Finance'];
Â  Â  Â  Â  Â  Â  const sortedAccountTypes = Object.keys(groupedByAccount).sort((a,b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const indexA = accountOrder.indexOf(a);
Â  Â  Â  Â  Â  Â  Â  Â  const indexB = accountOrder.indexOf(b);
Â  Â  Â  Â  Â  Â  Â  Â  if (indexA === -1) return 1;
Â  Â  Â  Â  Â  Â  Â  Â  if (indexB === -1) return -1;
Â  Â  Â  Â  Â  Â  Â  Â  return indexA - indexB;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (sortedAccountTypes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â container.innerHTML = `<div class="empty-state">ðŸ“Š<p>No holdings found. Log a transaction or clear your filters.</p></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  sortedAccountTypes.forEach(accountType => {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML += renderInvestmentGroup(accountType, groupedByAccount[accountType]);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderInvestmentGroup(groupName, holdings) {
Â  Â  Â  Â  Â  Â  const isWatchlist = groupName === WATCHLIST_ACCOUNT_TYPE;

Â  Â  Â  Â  Â  Â  const totalGroupValue = holdings.reduce((sum, h) => sum + (Number(h.totalShares) || 0) * (h.currentPrice || h.averagePurchasePrice), 0);
Â  Â  Â  Â  Â  Â  const totalGroupInvestedCostBasis = holdings
Â  Â  Â  Â  Â  Â  Â  Â  .filter(h => !isCashEquivalentType(h.type))
Â  Â  Â  Â  Â  Â  Â  Â  .reduce((sum, h) => sum + (Number(h.totalCost) || 0), 0);
Â  Â  Â  Â  Â  Â  const investedValue = holdings.filter(h => !isCashEquivalentType(h.type)).reduce((sum, h) => sum + ((Number(h.totalShares) || 0) * (h.currentPrice || h.averagePurchasePrice)), 0);
Â  Â  Â  Â  Â  Â  const totalGroupGainLoss = investedValue - totalGroupInvestedCostBasis;
Â  Â  Â  Â  Â  Â  const totalGroupReturnPercentage = totalGroupInvestedCostBasis > 0 ? (totalGroupGainLoss / totalGroupInvestedCostBasis) : 0;
Â  Â  Â  Â  Â  Â  let totalGroupDailyGainLoss = holdings.reduce((sum, h) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (h.currentPrice && h.previousClosePrice > 0 && !isCashEquivalentType(h.type)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return sum + ((h.currentPrice - h.previousClosePrice) * (Number(h.totalShares) || 0));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return sum;
Â  Â  Â  Â  Â  Â  }, 0);

Â  Â  Â  Â  Â  Â  let groupStatsHtml = '';
Â  Â  Â  Â  Â  Â  if (isWatchlist) {
Â  Â  Â  Â  Â  Â  Â  Â  groupStatsHtml = `<div class="group-stat-item"><div class="detail-label">Tracking ${holdings.length} symbols</div></div>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  groupStatsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-stat-item"><div class="detail-label">Value</div><div class="detail-value">${formatCurrency(totalGroupValue)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-stat-item"><div class="detail-label">Cost Basis</div><div class="detail-value">${formatCurrency(totalGroupInvestedCostBasis)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-stat-item"><div class="detail-label">G/L</div><div class="detail-value ${totalGroupGainLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalGroupGainLoss)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-stat-item"><div class="detail-label">G/L %</div><div class="detail-value ${totalGroupGainLoss >= 0 ? 'positive' : 'negative'}">${formatPercentage(totalGroupReturnPercentage)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-stat-item"><div class="detail-label">Today</div><div class="detail-value ${totalGroupDailyGainLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalGroupDailyGainLoss)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const holdingsBySymbol = {};
Â  Â  Â  Â  Â  Â  holdings.forEach(h => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!holdingsBySymbol[h.symbol]) holdingsBySymbol[h.symbol] = [];
Â  Â  Â  Â  Â  Â  Â  Â  holdingsBySymbol[h.symbol].push(h);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const sortedSymbols = Object.keys(holdingsBySymbol).sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const holdingsA = holdingsBySymbol[a][0];
Â  Â  Â  Â  Â  Â  Â  Â  const holdingsB = holdingsBySymbol[b][0];
Â  Â  Â  Â  Â  Â  Â  Â  const isCashA = isCashEquivalentType(holdingsA.type);
Â  Â  Â  Â  Â  Â  Â  Â  const isCashB = isCashEquivalentType(holdingsB.type);

Â  Â  Â  Â  Â  Â  Â  Â  if (isCashA && !isCashB) return -1;
Â  Â  Â  Â  Â  Â  Â  Â if (!isCashA && isCashB) return 1;

Â  Â  Â  Â  Â  Â  Â  Â  const valueA = holdingsBySymbol[a].reduce((sum, h) => sum + (h.totalShares * (h.currentPrice || 0)), 0);
Â  Â  Â  Â  Â  Â  Â  Â  const valueB = holdingsBySymbol[b].reduce((sum, h) => sum + (h.totalShares * (h.currentPrice || 0)), 0);
Â  Â  Â  Â  Â  Â  Â  Â  return valueB - valueA;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  let contentHtml = '';
Â  Â  Â  Â  Â  Â  sortedSymbols.forEach(symbol => {
Â  Â  Â  Â  Â  Â  Â  Â  const symbolHoldings = holdingsBySymbol[symbol];
Â  Â  Â  Â  Â  Â  Â  Â  if (isWatchlist || symbolHoldings.length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHtml += renderIndividualHolding(symbolHoldings[0]);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentHtml += renderConsolidatedHolding(symbol, groupName, symbolHoldings);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const isExpanded = !!uiState.expandedGroups[groupName];
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-group ${isExpanded ? 'expanded' : ''}" id="group-${groupName.replace(/\s+/g, '-')}" >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-group-header" data-group-type="${groupName}" onclick="toggleGroup('${groupName}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="group-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-title">${groupName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-stats">${groupStatsHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="toggle-icon">${isExpanded ? '&#9660;' : '&#9658;'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-group-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${contentHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isExpanded && holdings.length > 3 ? `<button class="btn collapse-group-btn" onclick="event.stopPropagation(); toggleGroup('${groupName}', true)">Collapse Section</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderIndividualHolding(h) {
Â  Â  Â  Â  Â  Â  const hasLivePrice = h.currentPrice !== null && h.currentPrice > 0;
Â  Â  Â  Â  Â  Â  const displayPrice = h.currentPrice || h.averagePurchasePrice;
Â  Â  Â  Â  Â  Â  const currentValue = (Number(h.totalShares) || 0) * displayPrice;
Â  Â  Â  Â  Â  Â  const totalGainLoss = currentValue - h.totalCost;
Â  Â  Â  Â  Â  Â  const totalReturnPercentage = h.totalCost > 0 ? (totalGainLoss / h.totalCost) : 0;
Â  Â  Â  Â  Â  Â  const annualIncome = (Number(h.dividend) || 0) * (Number(h.totalShares) || 0);
Â  Â  Â  Â  Â  Â  const yieldOnCost = h.totalCost > 0 ? (annualIncome / h.totalCost) : 0;
Â  Â  Â  Â  Â  Â  const isWatchlist = h.accountType === WATCHLIST_ACCOUNT_TYPE;
Â  Â  Â  Â  Â  Â  let todayGainLossAmount = 0;
Â  Â  Â  Â  Â  Â  let todayGainLossPercentage = 0;

Â  Â  Â  Â  Â  Â  if (hasLivePrice && !isCashEquivalentType(h.type) && h.previousClosePrice > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const previousCloseValue = h.previousClosePrice * (Number(h.totalShares) || 0);
Â  Â  Â  Â  Â  Â  Â  Â  todayGainLossAmount = (h.currentPrice - h.previousClosePrice) * (Number(h.totalShares) || 0);
Â  Â  Â  Â  Â  Â  Â  Â  todayGainLossPercentage = previousCloseValue > 0 ? (todayGainLossAmount / previousCloseValue) : 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  let headerHtml = '';
Â  Â  Â  Â  Â  Â  let detailsHtml = '';

Â  Â  Â  Â  Â  Â  // Determine classes for daily performance
Â  Â  Â  Â  Â  Â  const todayGLLabelClass = todayGainLossAmount >= 0 ? 'positive' : 'negative';
Â  Â  Â  Â  Â  Â  if (isWatchlist) {
Â  Â  Â  Â  Â  Â  Â  Â  headerHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="investment-header-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-symbol">${h.symbol}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: #666; font-size: 0.9em;">${h.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-header-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-value">${hasLivePrice ? formatCurrency(h.currentPrice) : '...'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-value ${todayGLLabelClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${hasLivePrice ? `${formatCurrency(todayGainLossAmount)} (${formatPercentage(todayGainLossPercentage)})` : '...'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  headerHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-header-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-symbol">${h.symbol}<span class="account-badge ${getAccountBadgeClass(h.accountType)}">${h.platform}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: var(--text-color-secondary); font-size: 0.9em;">${h.name} â€¢ ${h.type}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-header-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-edit" onclick="event.stopPropagation(); openHoldingEditModal('${h.symbol}', '${h.accountType}', '${h.platform}')">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="event.stopPropagation(); removeHolding('${h.symbol}', '${h.accountType}', '${h.platform}')">Remove</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  detailsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Shares</div><div class="detail-value">${(Number(h.totalShares) || 0).toLocaleString(undefined, { maximumFractionDigits: 4 })}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Avg. Cost</div><div class="detail-value">${formatCurrency(h.averagePurchasePrice)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Current Price</div><div class="detail-value">${hasLivePrice ? formatCurrency(h.currentPrice) : '...'}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Cost Basis</div><div class="detail-value">${formatCurrency(h.totalCost)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Market Value</div><div class="detail-value">${formatCurrency(currentValue)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Unrealized G/L</div><div class="detail-value ${totalGainLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalGainLoss)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Return %</div><div class="detail-value ${totalGainLoss >= 0 ? 'positive' : 'negative'}">${formatPercentage(totalReturnPercentage)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Today's G/L $</div><div class="detail-value ${todayGLLabelClass}">${hasLivePrice ? formatCurrency(todayGainLossAmount) : '...'}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Today's G/L %</div><div class="detail-value ${todayGLLabelClass}">${hasLivePrice ? formatPercentage(todayGainLossPercentage) : '...'}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Annual Income</div><div class="detail-value">${formatCurrency(annualIncome)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Yield on Cost</div><div class="detail-value">${formatPercentage(yieldOnCost)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-item"><div class="detail-label">Platform</div><div class="detail-value">${h.platform}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const uniqueKey = `${h.symbol}|||${h.accountType}|||${h.platform}`;
Â  Â  Â  Â  Â  Â  const isHistoryExpanded = !!uiState.expandedTransactions[uniqueKey];
Â  Â  Â  Â  Â  Â  const transactionsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="transaction-history ${isHistoryExpanded ? 'expanded' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transaction-history-header" onclick="toggleTransactionHistory('${uniqueKey}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Transaction History</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="toggle-icon">${isHistoryExpanded ? '&#9660;' : '&#9658;'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transaction-table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="transaction-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Date</th><th>Type</th><th>Shares</th><th>Price</th><th>Total</th><th>Actions</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${(h.transactions || []).sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.transactionType}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.shares ? t.shares.toLocaleString(undefined, {maximumFractionDigits: 4}) : 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.price ? formatCurrency(t.price) : 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.shares && t.price ? formatCurrency(t.shares * t.price) : (t.amount ? formatCurrency(t.amount) : 'N/A')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="transaction-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-edit" onclick="openEditModal(${t.id})">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="removeTransaction(${t.id})">Del</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  return `<div class="investment-item">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${headerHtml}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${detailsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ${isWatchlist ? '' : transactionsHtml}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderConsolidatedHolding(symbol, accountType, holdings) {
Â  Â  Â  Â  Â  Â  const totalShares = holdings.reduce((sum, h) => sum + (Number(h.totalShares) || 0), 0);
Â  Â  Â  Â  Â  Â  const totalCost = holdings.reduce((sum, h) => sum + (Number(h.totalCost) || 0), 0);
Â  Â  Â  Â  Â  Â  const hasLivePrice = holdings[0]?.currentPrice !== null && holdings[0]?.currentPrice > 0;
Â  Â  Â  Â  Â  Â  const currentPrice = holdings[0]?.currentPrice || 0;
Â  Â  Â  Â  Â  Â  const previousClosePrice = holdings[0]?.previousClosePrice || 0;
Â  Â  Â  Â  Â  Â  const totalValue = totalShares * currentPrice;
Â  Â  Â  Â  Â  Â  const avgCostBasis = totalShares > 0 ? totalCost / totalShares : 0;
Â  Â  Â  Â  Â  Â  const overallPL = hasLivePrice ? totalValue - totalCost : 0;
Â  Â  Â  Â  Â  Â  const overallPLPercent = hasLivePrice && totalCost > 0 ? overallPL / totalCost : 0;

Â  Â  Â  Â  Â  Â  let todayPL = 0;
Â  Â  Â  Â  Â  Â  let todayPLPercent = 0;
Â  Â  Â  Â  Â  Â  if (hasLivePrice && previousClosePrice > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  todayPL = (currentPrice - previousClosePrice) * totalShares;
Â  Â  Â  Â  Â  Â  Â  Â  const previousTotalValue = previousClosePrice * totalShares;
Â  Â  Â  Â  Â  Â  Â  Â  if (previousTotalValue > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â todayPLPercent = todayPL / previousTotalValue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const allTransactions = holdings.flatMap(h => h.transactions);
Â  Â  Â  Â  Â  Â  const todayPLLabelClass = todayPL >= 0 ? 'positive' : 'negative';

Â  Â  Â  Â  Â  Â  const purchasesHtml = holdings.map(h => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="purchase-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Shares: ${h.totalShares.toLocaleString(undefined, {maximumFractionDigits: 4})} @ ${formatCurrency(h.averagePurchasePrice)} on: <strong>${h.platform}</strong></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="purchase-item-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-edit" onclick="event.stopPropagation(); openHoldingEditModal('${h.symbol}', '${h.accountType}', '${h.platform}')">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="event.stopPropagation(); removeHolding('${h.symbol}', '${h.accountType}', '${h.platform}')">Delete</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');

Â  Â  Â  Â  Â  Â  const uniqueKey = `${symbol}|||${accountType}`;
Â  Â  Â  Â  Â  Â  const isHistoryExpanded = !!uiState.expandedTransactions[uniqueKey];
Â  Â  Â  Â  Â  Â  const transactionsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="transaction-history ${isHistoryExpanded ? 'expanded' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="transaction-history-header" onclick="toggleTransactionHistory('${uniqueKey}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Transaction History</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="toggle-icon">${isHistoryExpanded ? '&#9660;' : '&#9658;'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transaction-table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="transaction-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <tr><th>Date</th><th>Type</th><th>Platform</th><th>Shares</th><th>Price</th><th>Total</th><th>Actions</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${allTransactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.transactionType}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.platform}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.shares ? t.shares.toLocaleString(undefined, {maximumFractionDigits: 4}) : 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.price ? formatCurrency(t.price) : 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.shares && t.price ? formatCurrency(t.shares * t.price) : (t.amount ? formatCurrency(t.amount) : 'N/A')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="transaction-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-edit" onclick="openEditModal(${t.id})">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="removeTransaction(${t.id})">Del</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="investment-item consolidated">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="investment-header-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-symbol">${symbol}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: var(--text-color-secondary); font-size: 0.9em;">${holdings[0].name} â€¢ Multiple Platforms</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-header-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="detail-value" style="font-size: 1.4em;">${hasLivePrice ? formatCurrency(currentPrice) : '...'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="detail-value ${todayPLLabelClass}">${hasLivePrice ? `${formatCurrency(currentPrice - previousClosePrice)} (${formatPercentage(todayPLPercent)})` : '...'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="investment-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="consolidated-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-item"><span>Total Shares:</span> <span>${totalShares.toLocaleString(undefined, { maximumFractionDigits: 4 })}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-item"><span>Total Value:</span> <span>${hasLivePrice ? formatCurrency(totalValue) : '...'}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-item"><span>Avg. Cost Basis:</span> <span>${formatCurrency(avgCostBasis)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="purchase-breakdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Purchases in ${accountType}:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${purchasesHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="consolidated-footer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-item"><span>Overall P/L:</span> <span class="detail-value ${overallPL >= 0 ? 'positive' : 'negative'}">${hasLivePrice ? `${formatCurrency(overallPL)} (${formatPercentage(overallPLPercent)})` : '...'}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="summary-item"><span>P/L Today:</span> <span class="detail-value ${todayPLLabelClass}">${hasLivePrice ? formatCurrency(todayPL) : '...'}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${transactionsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Main Update Function ---
Â  Â  Â  Â  function updateDisplay() {
Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  const stats = calculateOverallStats(currentHoldings);
Â  Â  Â  Â  Â  Â  updateUserNameDisplay();
Â  Â  Â  Â  Â  Â  updateStats(stats);
Â  Â  Â  Â  Â  Â  const portfolioHistory = buildPortfolioHistoryFromTransactions(currentHoldings);
Â  Â  Â  Â  Â  Â  filterChart(activeChartFilter, portfolioHistory, currentHoldings);
Â  Â  Â  Â  Â  Â  populatePlatformFilter();
Â  Â  Â  Â  Â  Â  renderInvestments(currentHoldings);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- MODAL Functions for Editing Data ---
Â  Â  Â  Â  function openEditModal(transactionId) {
Â  Â  Â  Â  Â  Â  const transaction = portfolioData.transactions.find(t => t.id == transactionId);
Â  Â  Â  Â  Â  Â  if (!transaction) return;
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('editTransactionModal');
Â  Â  Â  Â  Â  Â  document.getElementById('editTransactionId').value = transactionId;
Â  Â  Â  Â  Â  Â  document.getElementById('editTransactionDate').value = transaction.date;

Â  Â  Â  Â  Â  Â  const fieldsContainer = document.getElementById('editTransactionFields');
Â  Â  Â  Â  Â  Â  fieldsContainer.innerHTML = ''; // Clear old fields
Â  Â  Â  Â  Â  Â  const type = transaction.transactionType.toUpperCase();

Â  Â  Â  Â  Â  Â  if (type === 'DEPOSIT' || type === 'WITHDRAWAL' || type === 'DIVIDEND') {
Â  Â  Â  Â  Â  Â  Â  Â  const amount = transaction.shares; // For these types, shares IS the amount
Â  Â  Â  Â  Â  Â  Â  Â  fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Amount</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="editAmount" step="any" value="${amount || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Shares</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="editShares" step="any" value="${transaction.shares || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Price</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="editPrice" step="any" value="${transaction.price || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeEditModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('editTransactionModal').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveTransactionEdit() {
Â  Â  Â  Â  Â  Â  const transactionId = document.getElementById('editTransactionId').value;
Â  Â  Â  Â  Â  Â  const transactionIndex = portfolioData.transactions.findIndex(t => t.id == transactionId);
Â  Â  Â  Â  Â  Â  if (transactionIndex === -1) return;
Â  Â  Â  Â  Â  Â  const transaction = portfolioData.transactions[transactionIndex];
Â  Â  Â  Â  Â  Â  transaction.date = document.getElementById('editTransactionDate').value;
Â  Â  Â  Â  Â  Â  const type = transaction.transactionType.toUpperCase();

Â  Â  Â  Â  Â  Â  if (type === 'DEPOSIT' || type === 'WITHDRAWAL' || type === 'DIVIDEND') {
Â  Â  Â  Â  Â  Â  Â  Â  const amount = parseFloat(document.getElementById('editAmount').value);
Â  Â  Â  Â  Â  Â  Â  Â  transaction.shares = amount;
Â  Â  Â  Â  Â  Â  Â  Â  transaction.price = 1;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  transaction.shares = parseFloat(document.getElementById('editShares').value);
Â  Â  Â  Â  Â  Â  Â  Â  transaction.price = parseFloat(document.getElementById('editPrice').value);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  closeEditModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  function openHoldingEditModal(symbol, accountType, platform) {
Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  const positionKey = `${symbol}|||${accountType}|||${platform}`;
Â  Â  Â  Â  Â  Â  const holding = currentHoldings.find(h => `${h.symbol}|||${h.accountType}|||${h.platform}` === positionKey);
Â  Â  Â  Â  Â  Â  if (!holding) return;

Â  Â  Â  Â  Â  Â  const modal = document.getElementById('editHoldingModal');
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingSymbol').value = symbol;
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingAccountTypeKey').value = accountType;
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingPlatformKey').value = platform;
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingSymbolDisplay').value = `${symbol} (${accountType} - ${platform})`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingType').value = holding.type || '';
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingTotalShares').value = holding.totalShares;
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingAvgPrice').value = holding.averagePurchasePrice;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const manualPriceInput = document.getElementById('editHoldingManualPrice');
Â  Â  Â  Â  Â  Â  const cachedInfo = priceCache[symbol] || {};
Â  Â  Â  Â  Â  Â  manualPriceInput.value = cachedInfo.manualPrice || '';

Â  Â  Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeHoldingEditModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('editHoldingModal').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveHoldingEdit() {
Â  Â  Â  Â  Â  Â  const symbol = document.getElementById('editHoldingSymbol').value;
Â  Â  Â  Â  Â  Â  const accountType = document.getElementById('editHoldingAccountTypeKey').value;
Â  Â  Â  Â  Â  Â  const platform = document.getElementById('editHoldingPlatformKey').value;
Â  Â  Â  Â  Â  Â  const newType = document.getElementById('editHoldingType').value;

Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  const holding = currentHoldings.find(h => h.symbol === symbol && h.accountType === accountType && h.platform === platform);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const newTotalShares = parseFloat(document.getElementById('editHoldingTotalShares').value);
Â  Â  Â  Â  Â  Â  const newAvgPrice = parseFloat(document.getElementById('editHoldingAvgPrice').value);
Â  Â  Â  Â  Â  Â  const newManualPrice = parseFloat(document.getElementById('editHoldingManualPrice').value);

Â  Â  Â  Â  Â  Â  if (!priceCache[symbol]) priceCache[symbol] = {};
Â  Â  Â  Â  Â  Â  if (!isNaN(newManualPrice) && newManualPrice >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  priceCache[symbol].manualPrice = newManualPrice;
Â  Â  Â  Â  Â  Â  Â  Â  priceCache[symbol].currentPrice = newManualPrice;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  delete priceCache[symbol].manualPrice;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (holding) {
Â  Â  Â  Â  Â  Â  Â  Â  const sharesChanged = Math.abs(newTotalShares - holding.totalShares) > 0.00001;
Â  Â  Â  Â  Â  Â  Â  Â  const priceChanged = Math.abs(newAvgPrice - holding.averagePurchasePrice) > 0.00001;
Â  Â  Â  Â  Â  Â  Â  Â  const typeChanged = newType !== holding.type;

Â  Â  Â  Â  Â  Â  Â  Â  if (sharesChanged || priceChanged) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const confirmationMessage = `This will replace all existing transactions for ${symbol} in this position with a single summary transaction. Are you sure?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal(confirmationMessage, async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const otherTransactions = portfolioData.transactions.filter(t => !(t.symbol === symbol && t.accountType === accountType && t.platform === platform));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const summaryTransaction = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transactionType: 'BUY',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: new Date().toISOString().split('T')[0],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symbol: symbol,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: holding.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shares: newTotalShares,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: newAvgPrice,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dividend: holding.dividend,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: newType, // Use the new type
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accountType: accountType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  platform: platform,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  portfolioData.transactions = [...otherTransactions, summaryTransaction];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (typeChanged) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // If only the type changed, update all associated transactions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  portfolioData.transactions.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.symbol === symbol && t.accountType === accountType && t.platform === platform) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.type = newType;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveDataToFirestore(); // Only save manual price change if nothing else was modified
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  closeHoldingEditModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  // CORRECTED: Added async keyword because this function uses 'await'.
Â  Â  Â  Â  async function toggleTransactionHistory(key) {
Â  Â  Â  Â  Â  Â  uiState.expandedTransactions[key] = !uiState.expandedTransactions[key];
Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Utility and Charting Functions ---
Â  Â  Â  Â  function formatCurrency(amount) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount); }
Â  Â  Â  Â  function formatPercentage(value) { return (value * 100).toFixed(2) + '%'; }
Â  Â  Â  Â  function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); document.querySelector('.theme-toggle').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™'; }
Â  Â  Â  Â  function toggleTheme() {
Â  Â  Â  Â  Â  Â  Â const newTheme = (document.documentElement.getAttribute('data-theme') || 'light') === 'dark' ? 'light' : 'dark';
Â  Â  Â  Â  Â  Â  Â localStorage.setItem(THEME_KEY, newTheme);
Â  Â  Â  Â  Â  Â  Â applyTheme(newTheme);
Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  const portfolioHistory = buildPortfolioHistoryFromTransactions(currentHoldings);
Â  Â  Â  Â  Â  Â  filterChart(activeChartFilter, portfolioHistory, currentHoldings);
Â  Â  Â  Â  }
Â  Â  Â  Â  function loadTheme() { applyTheme(localStorage.getItem(THEME_KEY) || 'light'); }

Â  Â  Â  Â  function debouncedUpdateUserName() {
Â  Â  Â  Â  Â  Â  clearTimeout(userNameUpdateTimeout);
Â  Â  Â  Â  Â  Â  userNameUpdateTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  updateUserName();
Â  Â  Â  Â  Â  Â  }, 800);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function updateUserName() {
Â  Â  Â  Â  Â  Â  portfolioData.username = document.getElementById('userNameInput').value.trim();
Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateUserNameDisplay() {
Â  Â  Â  Â  Â  Â  const el = document.getElementById('userNameDisplay');
Â  Â  Â  Â  Â  Â  const name = portfolioData.username;
Â  Â  Â  Â  Â  Â  el.textContent = name ? `for ${name}` : '';
Â  Â  Â  Â  Â  Â  document.getElementById('userNameInput').value = name;
Â  Â  Â  Â  Â  Â  document.title = name ? `${name}'s Portfolio` : 'Investment App';
Â  Â  Â  Â  }

Â  Â  Â  Â  function getAccountBadgeClass(accountType) { const map = { 'Regular Brokerage': 'account-regular', 'Roth IRA': 'account-roth', '401(k)': 'account-401k', '529 College Saving': 'account-529', 'Yahoo Finance': 'account-yahoo' }; return map[accountType] || 'account-regular'; }
Â  Â  Â  Â  function populatePlatformFilter() {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('filterPlatform');
Â  Â  Â  Â  Â  Â  if(!portfolioData.transactions) return;
Â  Â  Â  Â  Â  Â  const platforms = new Set(portfolioData.transactions.map(t => t.platform).filter(Boolean));
Â  Â  Â  Â  Â  Â  while (select.options.length > 1) select.remove(1);
Â  Â  Â  Â  Â  Â  platforms.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; select.appendChild(o); });
Â  Â  Â  Â  Â  Â  select.value = currentFilter;
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateCharts(dataPoints, holdings) {
Â  Â  Â  Â  Â  Â  const chartData = dataPoints || [];
Â  Â  Â  Â  Â  Â  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
Â  Â  Â  Â  Â  Â  const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
Â  Â  Â  Â  Â  Â  const labelColor = currentTheme === 'dark' ? '#f5f5f5' : '#333';
Â  Â  Â  Â  Â  Â  if(accountChart) accountChart.destroy(); if(investmentChart) investmentChart.destroy(); if(historicalChart) historicalChart.destroy(); if(dividendChart) dividendChart.destroy();

Â  Â  Â  Â  Â  Â  const portfolioHoldings = holdings.filter(h => h.accountType !== WATCHLIST_ACCOUNT_TYPE);
Â  Â  Â  Â  Â  Â  const accountData = portfolioHoldings.reduce((acc, h) => {
Â  Â  Â  Â  Â  Â  Â  Â  const val = (Number(h.totalShares) || 0) * (h.currentPrice || h.averagePurchasePrice);
Â  Â  Â  Â  Â  Â  Â  Â  if(h.accountType) acc[h.accountType] = (acc[h.accountType] || 0) + val;
Â  Â  Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  Â  Â  }, {});
Â  Â  Â  Â  Â  Â  const investmentData = portfolioHoldings.reduce((acc, h) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const val = (Number(h.totalShares) || 0) * (h.currentPrice || h.averagePurchasePrice);
Â  Â  Â  Â  Â  Â  Â  Â  if(h.type) acc[h.type] = (acc[h.type] || 0) + val; return acc;
Â  Â  Â  Â  Â  Â  Â }, {});

Â  Â  Â  Â  Â  Â  if(Object.keys(accountData).length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const accountColors = {'Regular Brokerage': '#3498db', 'Roth IRA': '#e74c3c', '401(k)': '#f39c12', '529 College Saving': '#9b59b6', 'Yahoo Finance': '#20c997'};
Â  Â  Â  Â  Â  Â  Â  Â  Â accountChart = new Chart(document.getElementById('accountChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(accountData), datasets: [{ data: Object.values(accountData), backgroundColor: Object.keys(accountData).map(l => accountColors[l] || '#95a5a6'), borderWidth: 3, borderColor: currentTheme === 'dark' ? '#121212' : '#f0f2f5' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: labelColor } } } } });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â if(Object.keys(investmentData).length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const investmentColors = {'Stock': '#2ecc71', 'ETF': '#3498db', 'Market Index': '#1abc9c', 'Bond': '#f39c12', 'Mutual Fund': '#9b59b6', 'Cryptocurrency': '#e67e22', 'Other': '#95a5a6', 'CASH': '#4CAF50', 'Money Market': '#4CAF50', '401k': '#f39c12'};
Â  Â  Â  Â  Â  Â  Â  Â  Â investmentChart = new Chart(document.getElementById('investmentChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(investmentData), datasets: [{ data: Object.values(investmentData), backgroundColor: Object.keys(investmentData).map(l => investmentColors[l] || '#95a5a6'), borderWidth: 3, borderColor: currentTheme === 'dark' ? '#121212' : '#f0f2f5' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: labelColor } } } } });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (chartData && chartData.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  historicalChart = new Chart(document.getElementById('historicalChart').getContext('2d'), { type: 'line', data: { labels: chartData.map(dp => new Date(dp.date).toLocaleDateString()), datasets: [{ label: 'Portfolio Value', data: chartData.map(dp => dp.value), borderColor: 'var(--accent-color-1)', backgroundColor: 'rgba(109, 40, 217, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: labelColor, callback: v => formatCurrency(v) }, grid: { color: gridColor } }, x: { ticks: { color: labelColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } } });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const dividendData = portfolioHoldings.map(h => {
Â  Â  Â  Â  Â  Â  Â  Â  const totalShares = h.totalShares;
Â  Â  Â  Â  Â  Â  Â  Â  return { symbol: h.symbol, income: (Number(totalShares) || 0) * (Number(h.dividend) || 0) };
Â  Â  Â  Â  Â  Â  }).filter(d => d.income > 0).sort((a,b) => b.income - a.income);
Â  Â  Â  Â  Â  Â  if (dividendData.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â dividendChart = new Chart(document.getElementById('dividendChart').getContext('2d'), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â type: 'bar',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â labels: dividendData.map(d => d.symbol),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â datasets: [{ label: 'Annual Income', data: dividendData.map(d => d.income), backgroundColor: 'rgba(39, 174, 96, 0.6)', borderColor: 'rgba(39, 174, 96, 1)', borderWidth: 1 }]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â indexAxis: 'y',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â responsive: true, maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â scales: { x: { ticks: { color: labelColor, callback: v => formatCurrency(v) }, grid: { color: gridColor } }, y: { ticks: { color: labelColor }, grid: { color: gridColor } } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â plugins: { legend: { display: false } }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveAutoRefreshState() { localStorage.setItem(AUTO_REFRESH_STATE_KEY, JSON.stringify(isAutoRefreshEnabled)); }
Â  Â  Â  Â  function loadAutoRefreshState() { const s = localStorage.getItem(AUTO_REFRESH_STATE_KEY); isAutoRefreshEnabled = s !== null ? JSON.parse(s) : true; }
Â  Â  Â  Â  function updateAutoRefreshButton() { const btn = document.getElementById('toggleAutoRefreshBtn'); if (isAutoRefreshEnabled) { btn.textContent = 'Pause Auto-Refresh'; btn.style.background = 'linear-gradient(45deg, #f39c12, #e67e22)'; } else { btn.textContent = 'Resume Auto-Refresh'; btn.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)'; } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function startAutoRefresh() {
Â  Â  Â  Â  Â  Â  if (countdownIntervalId !== null) clearInterval(countdownIntervalId); // Clear any existing interval
Â  Â  Â  Â  Â  Â  isAutoRefreshEnabled = true;

Â  Â  Â  Â  Â  Â  const countdownEl = document.getElementById('countdown-timer');
Â  Â  Â  Â  Â  Â  let timeLeft = autoRefreshIntervalSeconds;

Â  Â  Â  Â  Â  Â  countdownEl.style.display = 'block';
Â  Â  Â  Â  Â  Â  countdownEl.textContent = `Next update: ${timeLeft}s`;

Â  Â  Â  Â  Â  Â  countdownIntervalId = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  timeLeft--;
Â  Â  Â  Â  Â  Â  Â  Â  if (timeLeft <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshAllPrices(false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLeft = autoRefreshIntervalSeconds;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  countdownEl.textContent = `Next update: ${timeLeft}s`;
Â  Â  Â  Â  Â  Â  }, 1000);

Â  Â  Â  Â  Â  Â  updateAutoRefreshButton();
Â  Â  Â  Â  Â  Â  saveAutoRefreshState();
Â  Â  Â  Â  }

Â  Â  Â  Â  function stopAutoRefresh() {Â 
Â  Â  Â  Â  Â  Â  if (countdownIntervalId !== null) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(countdownIntervalId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  countdownIntervalId = null;Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  document.getElementById('countdown-timer').style.display = 'none';
Â  Â  Â  Â  Â  Â  isAutoRefreshEnabled = false;Â 
Â  Â  Â  Â  Â  Â  updateAutoRefreshButton();Â 
Â  Â  Â  Â  Â  Â  saveAutoRefreshState();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleAutoRefresh() { if (isAutoRefreshEnabled) stopAutoRefresh(); else { startAutoRefresh(); refreshAllPrices(true); } }
Â  Â  Â  Â  async function fetchPriceFromFinnhub(symbol) { if (!FINNHUB_API_KEY) return { currentPrice: null, previousClosePrice: null }; try { const url = `${CORS_PROXY}https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`; const r = await fetch(url); const d = await r.json(); return (r.ok && d && typeof d.c === 'number' && d.c > 0) ? { currentPrice: d.c, previousClosePrice: d.pc || null } : { currentPrice: null, previousClosePrice: null }; } catch (e) { console.error(e); return { currentPrice: null, previousClosePrice: null }; } }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Fetches price from Financial Modeling Prep (FMP). Used as the first fallback for Mutual Funds.
Â  Â  Â  Â  Â * @param {string} symbol The stock/fund symbol.
Â  Â  Â  Â  Â * @returns {object} Price data.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function fetchPriceFromFMP(symbol) {
Â  Â  Â  Â  Â  Â  Â if (!FMP_API_KEY) return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â // FMP quotes endpoint for latest price
Â  Â  Â  Â  Â  Â  Â  Â  Â const url = `${CORS_PROXY}https://financialmodelingprep.com/api/v3/quote/${symbol}?apikey=${FMP_API_KEY}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â const r = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  Â const d = await r.json();

Â  Â  Â  Â  Â  Â  Â  Â  Â // FMP returns an array of quotes, check if the array is not empty
Â  Â  Â  Â  Â  Â  Â  Â  Â if (r.ok && Array.isArray(d) && d.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const data = d[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentPrice: data.price || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â previousClosePrice: data.previousClose || null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("FMP fetch error:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchPriceFromAlphaVantage(symbol) {
Â  Â  Â  Â  Â  Â  if (!ALPHA_VANTAGE_API_KEY) return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const url = `${CORS_PROXY}https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
Â  Â  Â  Â  Â  Â  Â  Â  const r = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  const d = await r.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (d.Information || d.Note) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn(`Alpha Vantage API limit reached for ${symbol}. Price not updated.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const ts = d['Time Series (Daily)'];
Â  Â  Â  Â  Â  Â  Â  Â  if (ts) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dates = Object.keys(ts);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPrice: parseFloat(ts[dates[0]]['4. close']),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previousClosePrice: dates[1] ? parseFloat(ts[dates[1]]['4. close']) : null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  Â  Â  return { currentPrice: null, previousClosePrice: null };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateDataStatus(isSaved, msg = "") {
Â  Â  Â  Â  Â  Â  Â const el = document.getElementById('dataStatus');
Â  Â  Â  Â  Â  Â  Â el.classList.remove('saved', 'loading', 'error');
Â  Â  Â  Â  Â  Â  Â if (isSaved === true) {
Â  Â  Â  Â  Â  Â  Â  Â  Â el.textContent = 'â˜ï¸ Synced'; el.classList.add('saved');
Â  Â  Â  Â  Â  Â  Â } else if (isSaved === 'loading') {
Â  Â  Â  Â  Â  Â  Â  Â  Â el.textContent = 'ðŸ”„ Syncing...'; el.classList.add('loading');
Â  Â  Â  Â  Â  Â  Â } else if (isSaved === 'error') {
Â  Â  Â  Â  Â  Â  Â  Â  el.textContent = `âš ï¸ Error: ${msg}`; el.classList.add('error');
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â el.textContent = '...';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function filterChart(period, portfolioHistory) {
Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  activeChartFilter = period;
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.chart-filter-btn').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  Â  Â  const activeBtn = Array.from(document.querySelectorAll('.chart-filter-btn')).find(b => b.textContent === period);
Â  Â  Â  Â  Â  Â  if(activeBtn) activeBtn.classList.add('active');

Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  let startDate;
Â  Â  Â  Â  Â  Â  switch (period) {
Â  Â  Â  Â  Â  Â  Â  Â  case '1M': startDate = new Date(new Date().setMonth(now.getMonth() - 1)); break;
Â  Â  Â  Â  Â  Â  Â  Â  case '6M': startDate = new Date(new Date().setMonth(now.getMonth() - 6)); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
Â  Â  Â  Â  Â  Â  Â  Â  case '1Y': startDate = new Date(new Date().setFullYear(now.getFullYear() - 1)); break;
Â  Â  Â  Â  Â  Â  Â  Â  default: updateCharts(portfolioHistory, currentHoldings); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const filteredData = portfolioHistory.filter(dp => new Date(dp.date) >= startDate);
Â  Â  Â  Â  Â  Â  updateCharts(filteredData, currentHoldings);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Import/Export Functions ---
Â  Â  Â  Â  function exportCSV() {
Â  Â  Â  Â  Â  Â  if (!portfolioData.transactions || portfolioData.transactions.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showConfirmationModal("No transactions to export.", null);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const csv = Papa.unparse(portfolioData.transactions);
Â  Â  Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  link.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  }

Â  Â  Â  Â  function triggerCsvImport() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('csvFileInput').click();
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleCsvImport(e) {
Â  Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  Â  Â  Papa.parse(file, {
Â  Â  Â  Â  Â  Â  Â  Â  header: true,
Â  Â  Â  Â  Â  Â  Â  Â  dynamicTyping: false,
Â  Â  Â  Â  Â  Â  Â  Â  skipEmptyLines: true,
Â  Â  Â  Â  Â  Â  Â  Â  complete: function(results) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (results.errors.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("CSV Parsing Errors:", results.errors);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("Error parsing CSV file. Some rows may be malformed. Check console for details.", null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (results.data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("Import failed: CSV file is empty or contains no valid data rows.", null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let transactionsToImport = results.data.map((row, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cleanedRow = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const key in row) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedRow[key] = typeof row[key] === 'string' ? row[key].trim() : row[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedRow.id = parseFloat(cleanedRow.id) || Date.now() + index;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedRow.shares = parseFloat(cleanedRow.shares) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedRow.price = parseFloat(cleanedRow.price) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedRow.dividend = parseFloat(cleanedRow.dividend) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedRow.amount = parseFloat(cleanedRow.amount) || null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return cleanedRow;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal(`You are about to import ${transactionsToImport.length} transactions. This will overwrite ALL current data in the cloud. Continue?`, async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  portfolioData.transactions = transactionsToImport;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveDataToFirestore();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showConfirmationModal(`Successfully imported ${transactionsToImport.length} transactions.`, null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CORRECTED: Moved this line here to ensure the file input is cleared after parsing.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.target.value = null;
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  error: (err) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal(`A critical error occurred during import: ${err.message}`, null)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.target.value = null;
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function refreshMutualFunds() {
Â  Â  Â  Â  Â  Â  if (!isInitialDataLoaded) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const currentHoldings = calculateHoldingsAndCash();
Â  Â  Â  Â  Â  Â  const mutualFundHoldings = currentHoldings.filter(h => h.type === 'Mutual Fund');

Â  Â  Â  Â  Â  Â  if (mutualFundHoldings.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationModal("No mutual funds to refresh.", null);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const refreshButton = document.getElementById('refreshMFBtn');
Â  Â  Â  Â  Â  Â  refreshButton.textContent = 'Refreshing...';
Â  Â  Â  Â  Â  Â  refreshButton.disabled = true;
Â  Â  Â  Â  Â  Â  updateDataStatus('loading');

Â  Â  Â  Â  Â  Â  for (const holding of mutualFundHoldings) {
Â  Â  Â  Â  Â  Â  Â  Â  await delay(API_THROTTLE_DELAY); // Respect API limits
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const priceData = await fetchPrice(holding); // fetchPrice already has the FMP -> Alpha Vantage logic

Â  Â  Â  Â  Â  Â  Â  Â  if (priceData && priceData.currentPrice !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!priceCache[holding.symbol]) priceCache[holding.symbol] = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceCache[holding.symbol].currentPrice = priceData.currentPrice;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceCache[holding.symbol].previousClosePrice = priceData.previousClosePrice;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceCache[holding.symbol].lastFetchTimestamp = Date.now(); // Update timestamp to show it's fresh
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await saveDataToFirestore(); // Save the updated prices
Â  Â  Â  Â  Â  Â  refreshButton.textContent = 'Refresh Mutual Funds';
Â  Â  Â  Â  Â  Â  refreshButton.disabled = false;
Â  Â  Â  Â  }


Â  Â  Â  Â  // Make functions globally accessible for inline HTML onclick handlers
Â  Â  Â  Â  window.toggleTheme = toggleTheme;
Â  Â  Â  Â  window.openSettingsModal = openSettingsModal;
Â  Â  Â  Â  window.closeSettingsModal = closeSettingsModal;
Â  Â  Â  Â  window.saveSettings = saveSettings;
Â  Â  Â  Â  window.toggleAutoRefresh = toggleAutoRefresh;
Â  Â  Â  Â  window.refreshAllPrices = refreshAllPrices;
Â  Â  Â  Â  window.filterChart = (p) => filterChart(p, buildPortfolioHistoryFromTransactions(calculateHoldingsAndCash()));
Â  Â  Â  Â  window.toggleAddForm = toggleAddForm;
Â  Â  Â  Â  window.toggleTransactionFields = toggleTransactionFields;
Â  Â  Â  Â  window.validateSymbol = validateSymbol;
Â  Â  Â  Â  window.handleAccountTypeChange = handleAccountTypeChange;
Â  Â  Â  Â  window.updateTransactionFields = updateTransactionFields;
Â  Â  Â  Â  window.logTransaction = logTransaction;
Â  Â  Â  Â  window.exportCSV = exportCSV;
Â  Â  Â  Â  window.triggerCsvImport = triggerCsvImport;
Â  Â  Â  Â  window.clearAllData = clearAllData;
Â  Â  Â  Â  window.updateUserName = updateUserName;
Â  Â  Â  Â  window.debouncedUpdateUserName = debouncedUpdateUserName;
Â  Â  Â  Â  window.toggleGroup = toggleGroup;
Â  Â  Â  Â  window.removeHolding = removeHolding;
Â  Â  Â  Â  window.openHoldingEditModal = openHoldingEditModal;
Â  Â  Â  Â  window.closeHoldingEditModal = closeHoldingEditModal;
Â  Â  Â  Â  window.saveHoldingEdit = saveHoldingEdit;
Â  Â  Â  Â  window.toggleTransactionHistory = toggleTransactionHistory;
Â  Â  Â  Â  window.openEditModal = openEditModal;
Â  Â  Â  Â  window.closeEditModal = closeEditModal;
Â  Â  Â  Â  window.saveTransactionEdit = saveTransactionEdit;
Â  Â  Â  Â  window.removeTransaction = removeTransaction;
Â  Â  Â  Â  window.refreshMutualFunds = refreshMutualFunds;
Â  Â  </script>

Â  Â  <!-- MODALS -->
Â  Â  <div id="confirmationModal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <p id="modalMessage" class="modal-message"></p>
Â  Â  Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalConfirmBtn" class="btn btn-confirm">Confirm</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalCancelBtn" class="btn btn-cancel">Cancel</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="firebaseConfigModal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <h3>Firebase Configuration Required</h3>
Â  Â  Â  Â  Â  Â  <p style="margin: 10px 0 20px; color: var(--text-color-secondary); font-size: 0.9em;">
Â  Â  Â  Â  Â  Â  Â  Â  To connect to your private cloud database, please enter the configuration values from your Firebase project settings.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <div id="firebaseConfigError" style="display:none; background: #ffdddd; border: 1px solid #ffaaaa; color: #D8000C; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Your previous connection attempt failed. Please double-check your values.
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fbApiKey">apiKey</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fbApiKey" placeholder="Enter your apiKey">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fbAuthDomain">authDomain</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fbAuthDomain" placeholder="Enter your authDomain">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fbProjectId">projectId</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fbProjectId" placeholder="Enter your projectId">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fbStorageBucket">storageBucket</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fbStorageBucket" placeholder="Enter your storageBucket">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fbMessagingSenderId">messagingSenderId</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fbMessagingSenderId" placeholder="Enter your messagingSenderId">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fbAppId">appId</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fbAppId" placeholder="Enter your appId">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
Â  Â  Â  Â  Â  Â  <p style="margin: 10px 0 20px; color: var(--text-color-secondary); font-size: 0.9em;">
Â  Â  Â  Â  Â  Â  Â  Â  Or, import the configuration from a text or JSON file.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <input type="file" id="firebaseConfigFileInput" accept=".json,.txt" style="display: none;">
Â  Â  Â  Â  Â  Â  <div class="modal-buttons" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-cancel" onclick="document.getElementById('firebaseConfigFileInput').click()">Import from File</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-confirm" onclick="saveFirebaseConfig()">Save & Connect</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="editTransactionModal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â <button class="modal-close-btn" onclick="closeEditModal()">Ã—</button>
Â  Â  Â  Â  Â  Â  <h3>Edit Transaction</h3>
Â  Â  Â  Â  Â  Â  <input type="hidden" id="editTransactionId">
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="editTransactionDate">Date</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="editTransactionDate">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="editTransactionFields"></div>
Â  Â  Â  Â  Â  Â  Â <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-confirm" onclick="saveTransactionEdit()">Save</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="editHoldingModal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â <button class="modal-close-btn" onclick="closeHoldingEditModal()">Ã—</button>
Â  Â  Â  Â  Â  Â  <h3>Edit Position Details</h3>
Â  Â  Â  Â  Â  Â  <input type="hidden" id="editHoldingSymbol">
Â  Â  Â  Â  Â  Â  <input type="hidden" id="editHoldingAccountTypeKey">
Â  Â  Â  Â  Â  Â  <input type="hidden" id="editHoldingPlatformKey">
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Symbol</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="editHoldingSymbolDisplay" disabled>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="editHoldingType">Investment Type</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="editHoldingType">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Stock">Stock</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ETF">ETF</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Market Index">Market Index</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="401k">401k</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Bond">Bond</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Mutual Fund">Mutual Fund</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Cryptocurrency">Cryptocurrency</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Money Market">Money Market</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Manual">Manual (No Price Fetch)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CASH">CASH</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="editHoldingTotalShares">Total Shares</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="editHoldingTotalShares" step="any" min="0">
Â  Â  Â  Â  Â  Â  Â  Â  <small>Adjusting this will replace transactions for this specific position with a single summary record.</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="editHoldingAvgPrice">Average Cost / Share</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="editHoldingAvgPrice" step="any" min="0">
Â  Â  Â  Â  Â  Â  Â  Â  <small>Adjusting this will replace transactions for this specific position with a single summary record.</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="editHoldingManualPrice">Manual Current Price / Share (Optional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="editHoldingManualPrice" step="any" min="0">
Â  Â  Â  Â  Â  Â  Â  Â  <small>Use this to override the live price if fetching fails. Leave blank to use live data.</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-confirm" onclick="saveHoldingEdit()">Save</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-cancel" onclick="closeHoldingEditModal()">Cancel</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="settingsModal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <button class="modal-close-btn" onclick="closeSettingsModal()">Ã—</button>
Â  Â  Â  Â  Â  Â  <h3>Settings</h3>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="finnhubApiKeyInput">Finnhub API Key</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="finnhubApiKeyInput" placeholder="Enter your Finnhub API Key">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fmpApiKeyInput">Financial Modeling Prep (FMP) API Key</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fmpApiKeyInput" placeholder="Enter your FMP API Key">
Â  Â  Â  Â  Â  Â  Â  Â  <small>Used for Mutual Fund lookups before falling back to Alpha Vantage.</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="alphaVantageApiKeyInput">Alpha Vantage API Key</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="alphaVantageApiKeyInput" placeholder="Enter your Alpha Vantage API Key">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="autoRefreshIntervalInput">Auto-Refresh Interval (seconds)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="autoRefreshIntervalInput" step="1" min="30" placeholder="e.g., 75">
Â  Â  Â  Â  Â  Â  Â  Â  <small>Minimum 30 seconds to respect API limits.</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
Â  Â  Â  Â  Â  Â  Â <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Firebase Connection</label>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-cancel" onclick="resetFirebaseConnection()">Reset Connection</button>
Â  Â  Â  Â  Â  Â  Â  Â  <small>Use this if you need to enter a new Firebase configuration.</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-buttons" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-confirm" onclick="saveSettings()">Save Settings</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="container">
Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  Â  <div id="auth-container">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="signInBtn" class="btn" style="width:auto; display:none;">Sign in with Google</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="user-info" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="userPhoto" src="" alt="User photo">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="userName"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="signOutBtn" class="btn btn-danger">Sign Out</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="theme-toggle header-icon" onclick="toggleTheme()">â˜€ï¸</div>
Â  Â  Â  Â  Â  Â  <div class="settings-toggle header-icon" onclick="openSettingsModal()">âš™ï¸</div>
Â  Â  Â  Â  Â  Â  <div class="data-status" id="dataStatus">...</div>
Â  Â  Â  Â  Â  Â  <h1>ðŸ’° Investment App <span id="userNameDisplay"></span></h1>
Â  Â  Â  Â  Â  Â  <p>Track your investments with a detailed transaction log</p>
Â  Â  Â  Â  Â  Â  <div class="form-group" style="max-width: 300px; margin: 15px auto 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="userNameInput" style="color: var(--text-color-primary); font-weight: normal; font-size: 0.9em;">Your Name:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="userNameInput" placeholder="Enter your name" style="background: rgba(255, 255, 255, 0.9); border: none; color: #333;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â <div class="stat-card"> <div class="stat-value" id="totalValue">$0.00</div> <div class="stat-label">Total Portfolio Value</div> </div> <div class="stat-card"> <div class="stat-value" id="totalInvested">$0.00</div> <div class="stat-label">Total Cost Basis</div> </div> <div class="stat-card"> <div class="stat-value" id="totalCashValue">$0.00</div> <div class="stat-label">Cash & Money Market</div> </div> <div class="stat-card"> <div class="stat-value" id="unrealizedGainLoss">$0.00</div> <div class="stat-label">Unrealized G/L</div> </div> <div class="stat-card"> <div class="stat-value" id="realizedGainLoss">$0.00</div> <div class="stat-label">Realized G/L</div> </div> <div class="stat-card"> <div class="stat-value" id="todayPortfolioGainLoss">$0.00</div> <div class="stat-label">Today's G/L</div> </div> <div class="stat-card"> <div class="stat-value" id="estimatedAnnualIncome">$0.00</div> <div class="stat-label">Est. Annual Income</div> </div> <div class="stat-card"> <div class="stat-value" id="portfolioYieldOnCost">0.00%</div> <div class="stat-label">Portfolio Yield on Cost</div> </div> <div class="stat-card"> <div class="stat-value" id="bestPerformerValue">$0.00</div> <div class="stat-label">Best Performer (<span id="bestPerformerSymbol">N/A</span>)</div> </div> <div class="stat-card"> <div class="stat-value" id="worstPerformerValue">$0.00</div> <div class="stat-label">Worst Performer (<span id="worstPerformerSymbol">N/A</span>)</div> </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="refresh-button-container">
Â  Â  Â  Â  Â  Â  <button type="button" class="btn" id="toggleAutoRefreshBtn" onclick="toggleAutoRefresh()">Pause Auto-Refresh</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" id="refreshMFBtn" onclick="refreshMutualFunds()">Refresh Mutual Funds</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="btn" onclick="refreshAllPrices(true)">Refresh Now</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="charts-section">
Â  Â  Â  Â  Â  Â  <div class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Portfolio Performance History</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-filters">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="chart-filter-btn" onclick="filterChart('1M')">1M</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="chart-filter-btn" onclick="filterChart('6M')">6M</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="chart-filter-btn" onclick="filterChart('YTD')">YTD</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="chart-filter-btn" onclick="filterChart('1Y')">1Y</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="chart-filter-btn active" onclick="filterChart('All')">All</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper"> <canvas id="historicalChart"></canvas> </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="pie-charts-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-container"> <h3>Portfolio by Account Type</h3> <div class="chart-wrapper"> <canvas id="accountChart"></canvas> </div> </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-container"> <h3>Portfolio by Investment Type</h3> <div class="chart-wrapper"> <canvas id="investmentChart"></canvas> </div> </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Est. Annual Income by Holding</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="dividendChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="main-content">
Â  Â  Â  Â  Â  Â  <div class="add-investment card-panel">
				<div class="investment-group-header" onclick="toggleAddForm()" style="margin: -25px -25px 20px -25px; border-radius: 15px 15px 0 0; border-left-color: #27ae60; width: calc(100% + 50px);">
					<div class="group-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="group-title">Add New Investment <span class="account-badge" style="background: #27ae60;">Form</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
					<span class="toggle-icon" id="addFormToggleIcon">&#9658;</span>
				</div>
				<div id="addFormContent" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="transactionType">Transaction Type</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="transactionType" name="transactionType" onchange="toggleTransactionFields()" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="BUY">BUY</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="SELL">SELL</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="DIVIDEND">DIVIDEND</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="DEPOSIT">DEPOSIT</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="WITHDRAWAL">WITHDRAWAL</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"> <label for="transactionDate">Transaction Date</label> <input type="date" id="transactionDate" name="transactionDate" required> </div>
					<div class="form-group transaction-field"> <label for="symbol">Symbol</label> <input type="text" id="symbol" name="symbol" placeholder="e.g., AAPL, TSLA" oninput="validateSymbol()" required> <span id="symbolValidationStatus"></span> </div>
					<div class="form-group transaction-field"> <label for="name">Company Name</label> <input type="text" id="name" name="name" placeholder="e.g., Apple Inc." > </div>
					<div class="form-group"> <label for="accountType">Account Type</label> <select id="accountType" name="accountType" onchange="handleAccountTypeChange()" required> <option value="">Select Account</option> <option value="Regular Brokerage">Regular Brokerage</option> <option value="Roth IRA">Roth IRA</option> <option value="401(k)">401(k)</option> <option value="529 College Saving">529 College Saving</option> <option value="Yahoo Finance">Yahoo Finance</option> </select> </div>
					<div class="form-group" id="fundingSourceGroup" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="fundingSource">Fund Purchase From</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="fundingSource" name="fundingSource" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Options will be populated dynamically -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"> <label for="platform">Platform</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="platform" name="platform" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select Platform</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Fidelity">Fidelity</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Vanguard">Vanguard</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Charles Schwab">Charles Schwab</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Merrill Edge">Merrill Edge</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="E*TRADE">E*TRADE</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
					<div class="form-group transaction-field buy-sell-field"> <label for="shares">Number of Shares</label> <input type="number" id="shares" name="shares" step="any" min="0" placeholder="100" oninput="updateTransactionFields('shares')" required> </div>
					<div class="form-group transaction-field buy-sell-field"> <label for="price">Price per Share</label> <input type="number" id="price" name="price" step="any" min="0" placeholder="150.00" oninput="updateTransactionFields('price')" required> </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group transaction-field buy-sell-field">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="totalAmount">Total Amount (optional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="totalAmount" name="totalAmount" step="any" min="0" placeholder="100.00" oninput="updateTransactionFields('amount')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color: var(--text-color-secondary); font-size: 0.8em; margin-top: 4px; display: block;">Fill this in to auto-calculate shares.</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group cash-field" style="display:none;"> <label for="amount">Amount</label> <input type="number" id="amount" name="amount" step="any" min="0" placeholder="1000.00"> </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group transaction-field buy-sell-field"> <label for="dividend">Annual Dividend / Share (Est.)</label> <input type="number" id="dividend" name="dividend" step="any" min="0" placeholder="e.g., 3.50"> </div>
					<div class="form-group transaction-field buy-sell-field"> <label for="type">Investment Type</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <select id="type" name="type" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="">Select Type</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Stock">Stock</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="ETF">ETF</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Market Index">Market Index</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="401k">401k</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Bond">Bond</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Mutual Fund">Mutual Fund</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Cryptocurrency">Cryptocurrency</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Money Market">Money Market</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Manual">Manual (No Price Fetch)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="CASH">CASH</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
					<button type="button" class="btn" onclick="logTransaction()">Log Transaction</button>
				</div>
			</div>
Â  Â  Â  Â  Â  Â  <div class="investments-list card-panel">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Your Investments</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="search" id="searchInput" placeholder="Search by Symbol or Name...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="sortOptions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="default">Sort: Default</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="symbol-asc">Sort: Symbol (A-Z)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="value-desc">Sort: Highest Value</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="gain-desc">Sort: Biggest Gainer ($)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filterPlatform">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="all">Filter: All Platforms</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="investmentsList"> <div class="empty-state"> <div style="font-size: 3em; margin-bottom: 15px;">ðŸ“Š</div> <p>Connecting to database...</p> </div> </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="dataTransfer" class="card-panel">
Â  Â  Â  Â  Â  Â  <h2>Data Transfer</h2>
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="exportCSV()">Export Transactions (CSV)</button>
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="triggerCsvImport()">Import Transactions (CSV)</button>
Â  Â  Â  Â  Â  Â  <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
Â  Â  Â  Â  Â  Â  <button class="btn" id="clearAllDataBtn" onclick="clearAllData()">Clear All Cloud Data</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="countdown-timer" class="countdown-timer"></div>
</body>
</html>

